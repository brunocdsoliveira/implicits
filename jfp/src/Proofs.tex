%\stopcontents
\figtwocol{fig:ftype1}{System F Type System}{
\begin{center}
\framebox{%\scriptsize
\begin{minipage}{0.969\textwidth}
\bda{c}
\multicolumn{1}{c}{\myruleform{\fwte{\tenv}{E}{T}}} \\ \\
\myrule{F-Var}
  { (x : T) \in \tenv }
  { \fwte{\tenv}{x}{T} } \\ \\

\myrule{F-Abs}
  {\fwte{\tenv,\relation{x}{T_1}}{E}{T_2} } 
  {\fwte{\tenv}{\abs{x}{T_1}{E}}{T_1\to T_2} } \\ \\

\myrule{F-App}
 { \fwte{\tenv}{E_1}{T_2\to T_1} \quad\quad
   \fwte{\tenv}{E_2}{T_2} }
 { \fwte{\tenv}{\mmapp{E_1}{E_2}}{T_1} } \\ \\

\myrule{F-TApp}
  { \fwte{\tenv}{E}{\tall{\alpha}{T_2}} }
  { \fwte{\tenv}{\mmapp{E}{T_1}}{T_2[T_1/\alpha]} } \\ \\

\myrule{F-TAbs}
  { \fwte{\tenv,\alpha}{E}{T} }
  { \fwte{\tenv}{\Abs{\alpha}{E}}{\tall{\alpha}{T}} } 
\eda
\end{minipage}
}
\end{center}
}

%###############################################################################
\section{Proofs}

This appendix summarizes the proofs for the theorems presented in the article
as well as those of the auxiliary lemmas that feature in those proofs.
Several of the proofs have been mechanized in Coq; they are available from
\url{https://bitbucket.org/KlaraMar/cochiscoq} and this appendix refers to 
them where appropriate.

Throughout the proofs we refer to the type system rules of System F listed
in Figure~\ref{fig:ftype1}, also formalized in file systemF.v (inductive
definition \texttt{Typing}).

%-------------------------------------------------------------------------------
\subsection{Type Preservation}\label{proof:preservation}

Lemma~\ref{lemma:tp:1} states that the translation of expressions to System F preserves
types. Its proof relies on Lemma~\ref{lemma:tp:2}, which states that the translation
of resolution preserves types.

{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:tp:1}
  If 
\begin{equation*}
     \wte{\tenv}{e}{\rulet}{E}
\end{equation*}
  then
\begin{equation*}
     \fwte{\etrans\tenv}{E}{\etrans\rulet}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
	See file Cochis.v, Lemma \texttt{Typing\_TypePreservation}.
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:resolution}\label{lemma:tp:2}
  If 
\begin{equation*}
     \ares{\tenv}{\rulet}{e}
\end{equation*}
  then
\begin{equation*}
     \fwte{\etrans\tenv}{E}{\etrans\rulet}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
	See file Cochis.v, Lemma \texttt{amb\_res\_TypePreservation}.
\end{proof}

%-------------------------------------------------------------------------------
\subsection{Auxiliary Lemmas About Non-Determistic Resolution}

The non-deterministic resolution judgement enjoys a number of
typical binder-related properties.

The first lemma is the weakening lemma: it states that an extended type environment
preserves all the derivations of the original environment.

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}[Weakening]\label{lemma:weakening}
  If 
\begin{equation*}
  \ares{\tenv, \tenv'}{\rulet}{E}
\end{equation*}
  then
\begin{equation*}
  \ares{\tenv, \tenv'', \tenv'}{\rulet}{E}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
See file Cochis.v, Lemma \texttt{amb\_res\_weaken}.
\end{proof}
The second lemma is the substitution lemma which states that
we can drop an axiom from the type environment if it is already implied
by the remainder of the type environment.

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}[Substitution]\label{lemma:substitution}
  If 
\begin{equation*}
  \ares{\tenv, \envi{\rulet}{x}, \tenv'}{\rulet'}{E'}
\end{equation*}
  and
\begin{equation*}
  \ares{\tenv}{\rulet}{E}
\end{equation*}
  then
\begin{equation*}
  \ares{\tenv, \tenv'}{\rulet'}{E'[E/x]}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
	See file Cochis.v, Lemma \texttt{sub\_eimpl\_amb\_res}.
\end{proof}

%-------------------------------------------------------------------------------
\subsection{Soundness of Deterministic Resolution}

Lemma~\ref{lemma:s23:4} states that deterministic resolution is
sound with respect to non-deterministic resolution. 

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:s23:4}
  If 
\begin{equation*}
  \dres{\tenv}{\rulet}{E}
\end{equation*}
  then
\begin{equation*}
   \ares{\tenv}{\rulet}{E}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
See file CochisDet.v, Lemma \texttt{DRes\_Soundness}.

The lemma immediately follows from Lemma~\ref{lemma:s23:3}.
\end{proof} 
%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:s23:3}
  If 
\begin{equation*}
  \drres{\bar{\alpha}}{\tenv}{\rulet}{E}
\end{equation*}
  then
\begin{equation*}
  \ares{\tenv}{\rulet}{E}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
See file CochisDet.v, Lemma \texttt{DRes\_focus\_Soundness}.

This lemma is proved together with Lemma~\ref{lemma:s23:2} by mutual induction on the derivation of the first hypothesis of both lemmas.
\end{proof}
%The above proof relies on the following auxiliary lemma for the 
%resolution of simple types. The proof of this auxiliary lemma proceeds
%by mutual induction with the proof of the main lemma.
%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:s23:2}
  If 
\begin{equation*}
  \dlres{\bar{\alpha}}{\tenv}{\tenv'}{\type}{E}
\end{equation*}
  then
\begin{equation*}
  \ares{\tenv}{\type}{E}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
See file CochisDet.v, Lemma \texttt{DRes\_lookup\_Soundness}.

The proof proceeds by induction on the derivation, mutually 
with the previous proof.
\end{proof}
The above proof relies on the following lemma.

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:s23:1}
  If 
\begin{equation*}
  \dmres{\tenv}{\rulet}{E}{\type}{E'}{\ie{\ruleset}{\bar{x}}}
\end{equation*}
  and
\begin{equation*}
  \ares{\tenv}{\rulet}{E}
\end{equation*}
  and
\begin{equation*}
  \ares{\tenv}{\ruleset}{\bar{E}}
\end{equation*}
  then
\begin{equation*}
  \ares{\tenv}{\type}{E'[\bar{E}/\bar{x}]}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
See file CochisDet.v, Lemma \texttt{DRes\_match\_Soundness}.

The proof proceeds by induction on the derivation of the first assumption and relies on Lemmas~\ref{lemma:substitution} (Substitution) and~\ref{lemma:s23:5}.
\end{proof}
\klara{This is not the case any more. Remove.}
In order to deal with the de Bruijn variable representation in our mechanization,
judgement
\begin{equation*}
  \dmres{\tenv}{\rulet}{E}{\type}{E'}{\ie{\ruleset}{\bar{x}}}
\end{equation*}
differs from the corresponding mechanized definition (\texttt{DRes\_match} in file CochisDet.v) in the first argument, $\tenv$. In our mechanization, $\tenv$ is expressed by means of two environments, $\denv_m$ and $\tenv_m$, so that $\tenv = \tenv_m,\denv_m$.

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:s23:5}
If 
\begin{equation*}
  \dmres{\tenv}{\rulet}{E}{\type}{E'}{\ie{\ruleset}{\bar{x}}}
\end{equation*}
and
\begin{equation*}
  \ares{\tenv}{\rulet}{E}
\end{equation*}
then
\begin{equation*}
  \ares{\tenv, \envi{\ruleset}{\bar{x}}}{\type}{E'}
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
See file CochisDet.v, Lemma \tt{DRes\_match\_impl\_vars}.
\end{proof}

\subsection{Deterministic Resolution is Deterministic}\label{proof:determinism}

Figure~\ref{fig:unambenv} defines the judgment $\unambenv{\tenv}$ which states that a typing environment is unambiguous.
Essentially, the definition requires that all types $\rulet$ in $\tenv$ are unambiguous.
This definition will be used thoughout this section.

\figtwocol{fig:unambenv}{Unambiguous Type Environment}{
\begin{center}
\framebox{%\scriptsize
\begin{minipage}{0.969\textwidth}
\bda{c} 
\multicolumn{1}{c}{\myruleform{\unambenv{\tenv}}} \\ \\
\myrule{UE-Empty}
  { }
  { \unambenv{\epsilon} } \quad\quad\quad
  
\myrule{UE-Var}
  {\unambenv{\tenv} \\ \unambig{}{\rulet} }
  {\unambenv{\tenv, \relation{x}{\rulet}}}\\ \\

\myrule{UE-TVar}
  { \unambenv{\tenv} }
  { \unambenv{\tenv,\alpha} } \quad\quad\quad

\myrule{UE-Impl}
  { \unambenv{\tenv} \quad\quad \unambig{}{\rulet} }
  { \unambenv{\tenv, \envi{\rulet}{x}} }
\eda
\end{minipage}
}
\end{center}
}

The proofs of this section are split into subproofs for each sub-judgment (focusing, lookup and
matching) of the deterministic resolution judgment. Their dependencies, depicted in the diagram below, follow those of the sub-judgments that constitute the main deterministic resolution
judgment.
\begin{center}
\begin{tikzpicture}[node distance=1cm, auto,]
%nodes
\node[punkt] (DR) {Lemma~\ref{lemma:determinism:0}: \\
             \it Deterministic resolution judgment is deterministic};
\node[punkt, right=0.8cm of DR] (DFR) {Lemma~\ref{lemma:determinism:1}: \\
             \it Focusing judgment is deterministic};
\node[punkt, right=0.8cm of DFR] (DLR) {Lemma~\ref{lemma:determinism:2}: \\
             \it Lookup judgment is deterministic};
\node[punkt, right=0.8cm of DLR] (DMR) {Lemma~\ref{lemma:determinism:3}: \\
             \it Matching judgment is deterministic};
%edges
\draw[pil] (DR.north) to [out=30,in=150] (DFR.north);
\draw[pil] (DFR.north) to [out=30,in=150] (DLR.north);
\draw[pil] (DLR.south) to [out=210,in=330] (DFR.south);
\draw[pil] (DLR.north) to [out=30,in=150] (DMR.north);
\end{tikzpicture}
\end{center}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:determinism:0}
  If 
\begin{equation*}
  \unambenv{\tenv}
\end{equation*}
  and
\begin{equation*}
  \unambig{}{\rulet}
\end{equation*}
  and
\begin{equation*}
  \dres{\tenv}{\rulet}{E_1}
\end{equation*}
and
\begin{equation*}
  \dres{\tenv}{\rulet}{E_2}
\end{equation*}
then
\begin{equation*}
  E_1 = E_2
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
From the lemma's third and fourth hypotheses, the hypothesis
of rule \rref{R-Main} and Lemma~\ref{lemma:determinism:1} the desired
result follows
\begin{equation*}
  E_1 = E_2
\end{equation*}
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:determinism:1}
  If 
\begin{equation*}
  \unambig{}{\tenv}
\end{equation*}
  and
\begin{equation*}
  \unambig{}{\rulet}
\end{equation*}
  and
\begin{equation*}
  \drres{\bar{\alpha}}{\tenv}{\rulet}{E_1}
\end{equation*}
and
\begin{equation*}
  \drres{\bar{\alpha}}{\tenv}{\rulet}{E_2}
\end{equation*}
then
\begin{equation*}
  E_1 = E_2
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the third hypothesis.
\begin{description}
\setlength{\itemsep}{1em}
%===============================================================================
\item[\fbox{\rref{R-IAbs}}]
\quad$\drres{\bar{\alpha}}{\tenv}{\rulet_1 \iarrow \rulet_2}{\abs{x}{\etrans{\rulet_1}}{E_1}}$ \\
%===============================================================================

It follows that the lemma's fourth hypothesis is also derived by rule
\rref{R-IAbs}. It follows from the lemma's second hypothesis that 
\begin{equation*}
  \unambig{}{\rulet_1}\quad\wedge\quad \unambig{}{\rulet_2}
\end{equation*}
From this and lemma's first hypothesis, it follows that
\begin{equation*}
  \unambig{}{\tenv,\envi{\rulet_1}{x}}
\end{equation*}
From the rule's hypothesis and the induction hypothesis, it follows that
\begin{equation*}
  E_1 = E_2
\end{equation*}
Hence, we may conclude
\begin{equation*}
  \abs{x}{|\rulet_1|}{E_1} =  \abs{x}{|\rulet_1|}{E_2}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{R-TAbs}}]\quad$\drres{\bar{\alpha}}{\tenv}{\tall{\alpha}{\rulet}}{\Abs{\alpha}{E_1}}$ \\
%===============================================================================

It follows that the lemma's fourth hypothesis is also derived by rule
\rref{R-TAbs}. It follows from the lemma's second hypothesis that 
\begin{equation*}
  \unambig{\alpha}{\rulet}
\end{equation*}
The unambiguity judgment enjoys a weakening property which we use here to obtain
\begin{equation*}
  \unambig{}{\rulet}
\end{equation*}
From the lemma's first hypothesis, it follows that
\begin{equation*}
  \unambig{}{\tenv, \alpha}
\end{equation*}
From the rule's hypothesis and the induction hypothesis, it follows that
\begin{equation*}
  E_1 = E_2
\end{equation*}
Hence, we may conclude
\begin{equation*}
  \Abs{\alpha}{E_1} = \Abs{\alpha}{E_2}
%  \Lambda \alpha.E_1 = \Lambda \alpha.E_2
\end{equation*}

%===============================================================================
\item[\fbox{\rref{R-Simp}}]\quad$\drres{\bar{\alpha}}{\tenv}{\type}{E_1}$ \\
%$\bar{\alpha};\tenv \ivturns \type \leadsto E_1$ \ \\
%===============================================================================

It follows that the lemma's fourth hypothesis is also derived by rule
\rref{R-Simp}. We obtain the desired result from Lemma~\ref{lemma:determinism:2}
\begin{equation*}
  E_1 = E_2
\end{equation*}

\end{description}
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:determinism:2}
  If 
\begin{equation*}
  \unambig{}{\tenv}
%  \unamb \tenv
\end{equation*}
  and
\begin{equation*}
  \unambig{}{\tenv'}
%  \unamb \tenv'
\end{equation*}
  and
\begin{equation*}
  \dlres{\bar{\alpha}}{\tenv}{\tenv'}{\type}{E_1}
\end{equation*}
and
\begin{equation*}
  \dlres{\bar{\alpha}}{\tenv}{\tenv'}{\type}{E_2}
\end{equation*}
then
\begin{equation*}
  E_1 = E_2
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the third hypothesis.
\begin{description}
\setlength{\itemsep}{1em}
%===============================================================================
\item[\fbox{\rref{L-RuleMatch}}]\quad$\dlres{\bar{\alpha}}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E_1[\bar{E}'_1/\bar{x}]}$\\
%===============================================================================

  The rule's two hypotheses are
\begin{equation*}
\dmres{\tenv}{\rulet}{x}{\tau}{E_1}{\Sigma_1}
\end{equation*}%
where $\Sigma_1 = \overline{\rulet'_1~\gbox{\leadsto x}}$ , 
  and
\begin{equation*}
\drres{\bar{\alpha}}{\tenv}{\rulet'_1}{E'_1} \quad (\forall \rulet'_1 \in \overline{\rulet}'_1)
\end{equation*}%
  Then the fourth hypothesis was either derived from rule \rref{L-RuleMatch},
  or from rule \rref{L-RuleNoMatch}. However, the hypothesis of the latter is
  not satisfied: $\epsilon;E_1;\Sigma_1$ forms a counter-example. Hence, using rule \rref{L-RuleMatch}
  the fourth hypothesis is also derived.

  Then it follows from the first hypothesis of the rule (given above),
  from the first hypothesis of the lemma, which entails $\unambig{}{\rulet}$,  
  and from Lemma~\ref{lemma:determinism:3} (with $\bar{\sigma}_1 = \bar{\sigma}_2 = \bar{\sigma}_1' = \bar{\sigma}_2' = \epsilon$) that
\begin{equation*}
  E_1 = E_2 \quad\wedge\quad \Sigma_1 = \Sigma_2
\end{equation*}
  From the second hypothesis of the rule and Lemma~\ref{lemma:determinism:1} it also follows that
\begin{equation*}
  \bar{E}'_1 = \bar{E}'_2
\end{equation*}
  Hence, we may conclude
\begin{equation*}
  E_1[\bar{E}'_1/\bar{x}] = E_2[\bar{E_2}'/\bar{x}]
\end{equation*}


%===============================================================================
\item[\fbox{\rref{L-RuleNoMatch}}]\quad$\dlres{\bar{\alpha}}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E_1'}$\\
%===============================================================================

  Then the fourth hypothesis was either derived from rule \rref{L-RuleMatch},
  or from rule \rref{L-RuleNoMatch}. However, the hypothesis of the former is
  not satisfied, as it would be a counter-example for the first hypothesis of
  the assumed rule of the third hypothesis. Hence, the fourth hypothesis is also
  formed by rule \rref{L-RuleNoMatch}.

  From the second hypothesis of the lemma we derive $\unambig{}{\tenv'}$.
  Then from the second hypothesis of the rule and the induction hypothesis we conclude
  the desired result
\begin{equation*}
  E_1' = E_2'
\end{equation*}

%===============================================================================
\item[\fbox{\rref{L-Var}}]\quad$\dlres{\bar{\alpha}}{\tenv}{\tenv',x:\rulet}{\type}{E_1}$\\
%$\bar{\alpha};\tenv;\tenv',x:\rulet \ivturns \type \leadsto E_1$ \ \\
%===============================================================================

  Clearly the fourth hypothesis is also derived by rule \rref{L-Var}.
  Moreover, from the second hypothesis it follows that $\unambig{}{\tenv'}$.
  Hence, from the induction hypothesis we conclude that
\begin{equation*}
  E_1 = E_2
\end{equation*}

%===============================================================================
\item[\fbox{\rref{L-TyVar}}]\quad$\dlres{\bar{\alpha}}{\tenv}{\tenv',\alpha}{\type}{E_1}$\\
%$\bar{\alpha};\tenv;\tenv',\alpha \ivturns \type \leadsto E_1$ \ \\
%===============================================================================
  Clearly the fourth hypothesis is also derived by rule \rref{L-TyVar}.
  Moreover, from the second hypothesis it follows that $\unambig{}{\tenv'}$.
  Hence, from the induction hypothesis we conclude that
\begin{equation*}
  E_1 = E_2
\end{equation*}
\end{description}
\end{proof}

Before proceeding with the matching judgment, we present a version of it that
is annotated with the sequence of substitution types $\bar{\suty}$
used to instantiate the universal quantifiers.

{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{center}
$\ba{c}
\myruleform{\dmresa{\bar{\suty}}{\tenv}{\rulet}{E}{\type}{E'}{\Sigma}} \\ \\

\myrule{M-Simp}{}{\dmresa{\epsilon}{\tenv}{\type}{E}{\type}{E}{\epsilon}} \\ \\

\myrule{M-IApp}
       {\dmresa{\bar{\suty}}{\tenv,\envi{\rulet_1}{x}}{\rulet_2}{E\,x}{\type}{E'}{\Sigma} \\
        \gbox{x~\mathit{fresh}}}
       {\dmresa{\bar{\suty}}{\tenv}{\rulet_1 \To \rulet_2}{E}{\type}{E'}{\ie{\rulet_1}{x},\Sigma}}\\\\
\myrule{M-TApp}
       {\dmresa{\bar{\suty}}{\tenv}{\rulet[\suty/\alpha]}{E\,|\suty|}{\type}{E'}{\Sigma} \\
        \wfty{\tenv}{\suty}}
       {\dmresa{\bar{\suty},\suty}{\tenv}{\forall \alpha. \rulet}{E}{\type}{E'}{\Sigma}}\\

%\mylabel{M-TApp} \quad
%  \myirule{\bar{\suty};\tenv; \rulet[\suty/\alpha] ~\gbox{\leadsto E\,|\suty|} \ivturns \type~\gbox{\leadsto E'; \Sigma}
%           \quad\quad\quad
%           \tenv \turns \suty
%          }
%          {\bar{\suty},\suty;\tenv; \forall \alpha. \rulet ~\gbox{\leadsto E} \ivturns \type~\gbox{\leadsto E'}; \Sigma} \\
\ea
$
\end{center}
\end{minipage}
}}\\

It is not difficult to see that any derivation of the annotated judgement
is in one to one correspondence with a derivation of the unannotated 
judgement.

Now we are ready to show that the judgement is deterministic.\\

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:determinism:3}
  If 
\begin{equation*}
  \unambig{\bar{\alpha}}{\rulet}
%  \bar{\alpha} \unamb \rulet
\end{equation*}
  and
\begin{equation*}
  \dmresa{\bar{\suty}_1}{\tenv}{\rulet[\bar{\suty}_2/\bar{\alpha}]}{E[|\bar{\suty}_2|/\bar{\alpha}]}{\type}{E_1}{\Sigma_1}
%  \bar{\suty}_1 ; \tenv; \rulet[\bar{\suty}_2/\bar{\alpha}]\leadsto E[|\bar{\suty}_2|/\bar{\alpha}] \ivturns \type \leadsto E_1; \Sigma_1
\end{equation*}
and
\begin{equation*}
  \dmresa{\bar{\suty}_1'}{\tenv}{\rulet[\bar{\suty}_2'/\bar{\alpha}]}{E[|\bar{\suty}_2'|/\bar{\alpha}]}{\type}{E_2}{\Sigma_2}
%  \bar{\suty}_1' ; \tenv; \rulet[\bar{\suty}_2'/\bar{\alpha}]\leadsto E[|\bar{\suty}_2'|/\bar{\alpha}] \ivturns \type \leadsto E_2; \Sigma_2
\end{equation*}
then
\begin{equation*}
  \bar{\suty}_1 = \bar{\suty}_1' \andl \bar{\suty}_2 = \bar{\suty}_2'
  \andl E_1 = E_2 \andl \Sigma_1 = \Sigma_2
  \andl \unambig{}{\Sigma_1}
\end{equation*}
% where
% \begin{equation*}
% \begin{array}{c}
%   \myruleform{\bar{\suty}; \rulet \vdash \type} \\ \\
%   \mylabel{P-1} \quad \myirule{}{\epsilon; \type \vdash \type} \\ \\
%   \mylabel{P-2} \quad \myirule{\bar{\suty}; \rulet_2 \vdash \type}{\bar{\suty}; \rulet_1 \iarrow \rulet_2 \vdash \type}
%   \mylabel{P-3} \quad \myirule{\bar{\suty}; \rulet[\suty/\alpha] \vdash \type}{\suty,\bar{\suty}; \forall\alpha.\rulet \vdash \type}
% \end{array}
% \end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the first hypothesis.
\begin{description}
\setlength{\itemsep}{1em}
%===============================================================================
\item[\fbox{\rref{UA-Simp}}]\quad$\unambig{\bar{\alpha}}{\type'}$ \\
%$\bar{\alpha} \unamb \type'$ \ \\
%===============================================================================

  Then the second and third hypothesis of the lemma must have been formed by rule \rref{M-Simp}
  and hence 
\begin{equation*}
  \bar{\suty}_1 = \epsilon = \bar{\suty}_1'
\end{equation*}
  
  For the same reason we have that $\type'[\bar{\suty}_2/\bar{\alpha}] = \type = \type'[\bar{\suty}_2'/\bar{\alpha}]$. Since we know that $\bar{\alpha} \subseteq \mathit{ftv}(\type)$, it must follow also that
\begin{equation*}
  \bar{\suty}_2 = \bar{\suty}_2'
\end{equation*}

  As a consequence, we also have that
\begin{equation*}
  E_1 = E[|\bar{\sigma}_2|/\bar{\alpha}] = E[|\bar{\sigma}_2'|/\bar{\alpha}] = E_2
\end{equation*}

  Finally, it also follows from rule \rref{M-Simp} that
\begin{equation*}
  \Sigma_1 = \epsilon = \Sigma_2
\end{equation*}
  and trivially
\begin{equation*}
  \unambig{}{\epsilon}
\end{equation*}
%===============================================================================
\item[\fbox{\rref{UA-IAbs}}]\quad$\unambig{\bar{\alpha}}{\rulet_1 \To \rulet_2}$ \\
%$\bar{\alpha} \unamb \rulet_1 \iarrow \rulet_2$ \ \\
%===============================================================================

  Then the second and third hypothesis of the lemma must have been formed by rule \rref{M-IApp}.
  From their two hypotheses and from the hypothesis of the rule and the induction hypothesis, we obtain
  the desired results
\begin{equation*}
  \bar{\suty}_1 = \bar{\suty}_1' \andl \bar{\suty}_2 = \bar{\suty}_2'
  \andl
  E_1 = E_2
  \andl
  \Sigma_1,\ie{\rulet_1[|\bar{\sigma}_2|/\bar{\alpha}]}{x}
  = 
  \Sigma_2,\ie{\rulet_1[|\bar{\sigma}_2'|/\bar{\alpha}]}{x}
\end{equation*}

  We also derive from the induction hypothesis that $\unambig{}{\Sigma_1}$. 
  Since $\unambig{\bar{\alpha}}{\rulet_1 \To \rulet_2}$, we also have $\unambig{}{\rulet_1}$.
  Hence we also conclude
\begin{equation*}
  \unambig{}{\Sigma_1,\ie{\rulet_1}{x}}
\end{equation*}
%===============================================================================
\item[\fbox{\rref{UA-TAbs}}]\quad$\unambig{\bar{\alpha}}{\forall \alpha.\rulet}$\\
%$\bar{\alpha} \unamb \forall \alpha.\rulet$ \ \\
%===============================================================================

Then the second and third hypothesis of the lemma must have been formed by rule \rref{M-TApp},
  with $\bar{\suty}_1 = \bar{\suty}_{1,1},\suty_{1,2}$ and $\bar{\suty}_1' = \bar{\suty}_{1,1}',\suty_{1,2}'$.
  From their two hypotheses and from the hypothesis of the rule and the induction hypothesis, we obtain
\begin{equation*}
  \bar{\suty}_2,\suty_{1,2} = \bar{\suty}_2',\suty_{1,2}' 
  \andl
  \bar{\suty}_{1,1} = \bar{\suty}_{1,1}'
  \andl
  E_1 = E_2
  \andl
  \Sigma_1 = \Sigma_2
  \andl
  \unambig{}{\Sigma_1}
\end{equation*}
  
  From this we conclude the desired result 
\begin{equation*}
  \bar{\suty}_1 = \bar{\suty}_1' \andl \bar{\suty}_2 = \bar{\suty}_2'
  \andl
  E_1 = E_2
  \andl
  \Sigma_1 = \Sigma_2
  \andl
  \unambig{}{\Sigma_1}
\end{equation*}
\end{description}
\end{proof}

%-------------------------------------------------------------------------------
\subsection{Resolution Stability}\label{proof:coherence}

Deterministic resolution is stable under substitution.

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:coherence:0}
  If 
\begin{equation*}
  \dres{\tenv,\alpha,\tenv'}{\rulet}{E}
%   \tenv,\alpha,\tenv' \ivturns \rulet\leadsto E
\end{equation*}
  and
\begin{equation*}
  \wfty{\tenv}{\suty}
%  \tenv \turns \suty
\end{equation*}
  then
\begin{equation*}
  \dres{\tenv,\tenv'[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[|\suty|/\alpha]}
%  \tenv,\tenv'[\suty/\alpha] \ivturns \rulet[\suty/\alpha] \leadsto E[|\suty|/\alpha]
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
  The proof proceeds by induction on the first derivation and uses Lemma~\ref{lemma:coherence:1}.
  
  The hypothesis of rule \rref{R-Main} then is
\begin{equation*}
  \drres{\ftv{\tenv},\alpha,\ftv{\tenv'}}{\tenv,\alpha,\tenv'}{\rulet}{E}
\end{equation*}

  From Lemma~\ref{lemma:coherence:1} it follows that
\begin{equation*}
  \drres{\ftv{\tenv},\ftv{\tenv'}}{\tenv,\tenv'[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}

  As $\ftv{\tenv'} = \ftv{\tenv'[\suty/\alpha]}$, the desired result follows from rule
  \rref{R-Main}
\begin{equation*}
 \dres{\tenv,\tenv'[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}
\end{proof}
%###############################################################################

The next two proofs make use of the auxiliary definition R, shown in
Figure~\ref{fig:R}. The relation $R(\tenv;\alpha;\tenv';\tenv'';\tenv''';\suty)$ states that
when performing a type substitution $\vsubst{\tenv,\alpha,\tenv'}{[\suty/\alpha]}$, then
any $\tenv'' \subseteq \tenv,\alpha,\tenv'$, results to $\tenv'''$ after the substitution has
been performed. The two cases of the relation are necessary to separate between
$\alpha\in\tenv''$ and $\alpha\notin\tenv''$.

\figtwocol{fig:R}{Auxiliary Definition R}{
\begin{center}
\fbox{%\scriptsize
\begin{minipage}{0.969\textwidth}
\bda{c}
\multicolumn{1}{c}{\myruleform{R(\tenv;\alpha;\tenv';\tenv'';\tenv''';\suty)}} \\ \\

\myrule{R-1}{}
  {\quad R(\tenv_1,\tenv_2;\alpha;\tenv';\tenv_1;\tenv_1;\suty)} \\ \\

\myrule{R-2}{}
{\quad R(\tenv;\alpha;\tenv_1',\tenv_2';\tenv,\alpha,\tenv_1';\tenv,\tenv_1'[\suty/\alpha];\suty)}
\eda
\end{minipage}
}
\end{center}
}

{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:coherence:1}
  If 
\begin{equation*}
  \drres{\bar{\alpha},\alpha,\bar{\alpha}}{\tenv,\alpha,\tenv'}{\rulet}{E}
\end{equation*}
  and
\begin{equation*}
  \wfty{\tenv}{\suty}
\end{equation*}
  then
\begin{equation*}
  \drres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the first hypothesis, mutually with Lemma~\ref{lemma:coherence:2}.
\begin{description}
\setlength{\itemsep}{1em}

%===============================================================================
\item[\fbox{\rref{R-IAbs}}]\quad$\drres{\bar{\alpha},\alpha,\bar{\alpha}'}{\tenv,\alpha,\tenv'}{\rulet_1 \To \rulet_2}{\abs{x}{|\rulet_1|}{E}}$ \\
%===============================================================================

From the rule's hypothesis and the induction hypothesis we have
\begin{equation*}
\drres{\bar{\alpha},\bar{\alpha}'}{\tenv,(\tenv',\envi{\rulet_1}{x})[\suty/\alpha]}{\rulet_2[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}
From the definition of substitution and rule \rref{R-IAbs} we then conclude
\begin{equation*}
\drres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{(\rulet_1 \iarrow \rulet_2)[\suty/\alpha]}{(\abs{x}{\etrans{\rulet_1}}{E})[|\suty|/\alpha]}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{R-TAbs}}]\quad$\drres{\bar{\alpha},\alpha,\bar{\alpha}'}{\tenv,\alpha,\tenv'}{\tall{\beta}{\rulet}}{\Abs{\beta}{E}}$\\
%===============================================================================

From the rule's hypothesis and the induction hypothesis we have
\begin{equation*}
\drres{\bar{\alpha},\bar{\alpha}'}{\tenv,(\tenv',\beta)[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}
From the definition of substitution and rule \rref{R-TAbs} we then conclude
\begin{equation*}
\drres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{(\tall{\beta}{\rulet})[\suty/\alpha]}{(\Abs{\beta}{E})[|\suty|/\alpha]}
\end{equation*}
%===============================================================================
\item[\fbox{\rref{R-Simp}}]\quad$\drres{\bar{\alpha},\alpha,\bar{\alpha}'}{\tenv,\alpha,\tenv'}{\type}{E}$ \\
%$\bar{\alpha},\alpha,\bar{\alpha}';\tenv,\alpha,\tenv'\ivturns \type \leadsto E$ \ \\
%===============================================================================

From the rule's hypothesis and Lemma~\ref{lemma:coherence:2} we conclude
\begin{equation*}
\dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\tenv'''}{\type[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}
  and
\begin{equation*}
  R(\tenv;\alpha;\tenv';\tenv,\alpha,\tenv';\tenv''';\suty)
\end{equation*}
  The latter could only have been obtained by rule \mylabel{R-2}. 
  Hence, we know that $\tenv''' = \tenv,\tenv'[\suty/\alpha]$ and the former is equivalent to
\begin{equation*}
\dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\tenv,\tenv'[\suty/\alpha]}{\type[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}
With this fact we can conclude by rule \rref{R-Simp}
\begin{equation*}
\drres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\type[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}
\end{description}
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:coherence:2}
  If 
\begin{equation*}
\dlres{\bar{\alpha},\alpha,\bar{\alpha}'}{\tenv,\alpha,\tenv'}{\tenv''}{\type}{E}
\end{equation*}
  and
\begin{equation*}
  \tenv'' \subseteq \tenv,\alpha,\tenv'
\end{equation*}
  and
\begin{equation*}
\wfty{\tenv}{\suty}
\end{equation*}
  then
\begin{equation*}
\dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\tenv'''}{\type[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}
  and
\begin{equation*}
  R(\tenv;\alpha;\tenv';\tenv'';\tenv''';\suty)
\end{equation*}
\end{lemma}
  
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the first hypothesis, mutually with Lemma~\ref{lemma:coherence:1}.
\begin{description}
\setlength{\itemsep}{1em}
%===============================================================================
\item[\fbox{\rref{L-RuleMatch}}]\quad$
\dlres{\bar{\alpha},\alpha,\bar{\alpha}'}{\tenv,\alpha,\tenv'}{\tenv'',\envi{\rulet}{x}}{\type}{E}$ \ \\
%===============================================================================

  Then it follows from the first hypothesis of the rule and of Lemma~\ref{lemma:coherence:3}
  that
\begin{equation*}
\dmres{\tenv,\tenv'[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[|\suty|/\alpha]}{\type[\suty/\alpha]}{E'[|\suty|/\alpha]}{\ie{\ruleset[\suty/\alpha]}{\bar{x}}}
\end{equation*}
  Also it follows from the second hypothesis of the rule and of Lemma~\ref{lemma:coherence:1}
  that
\begin{equation*}
\drres{{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\ruleset[\suty/\alpha]}{\bar{E}[|\suty|/\alpha]}
\end{equation*}
  By combining these two observations with rule \rref{L-RuleMatch} we obtain the first desired result
\begin{equation*}
\dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\tenv''',\envi{\rulet[\suty/\alpha]}{x}}{\type[\suty/\alpha]}{E[|\suty|/\alpha]}
\end{equation*}  
  We obtain the second desired result by case analysis on $\tenv'' \subseteq \tenv,\alpha,\tenv'$:
  \begin{enumerate}
  \item $\tenv = \tenv_1,\envi{\rulet}{x},\tenv_2 \quad\wedge\quad \tenv'' = \tenv_1$: \\
  In this case we can use rule \mylabel{R-1} to establish:
\begin{equation*}
  R((\tenv_1,\envi{\rulet}{x}),\tenv_2;\alpha;\tenv';\tenv_1,\envi{\rulet}{x};\tenv_1,\envi{\rulet}{x};\sigma)
\end{equation*}
  which is equivalent to
\begin{equation*}
  R(\tenv;\alpha;\tenv';\tenv'',\envi{\rulet}{x};\tenv'',\envi{\rulet}{x};\sigma)
\end{equation*}

  \item $\tenv' = \tenv_1',\envi{\rulet}{x}, \tenv_2' \andl \tenv'' = \tenv,\alpha,\tenv_1'$: \\
  In this case we can use rule \mylabel{R-2} to establish:
\begin{equation*}
  R(\tenv;\alpha;(\tenv_1',\envi{\rulet}{x}),\tenv_2';\tenv,\alpha,(\tenv_1',\envi{\rulet}{x});
  \tenv,(\tenv_1',\envi{\rulet}{x})[\suty/\alpha];\sigma)
\end{equation*}
  which is equivalent to
\begin{equation*}
  R(\tenv;\alpha;\tenv';\tenv'',\envi{\rulet}{x};\tenv,(\tenv_1',\envi{\rulet}{x})[\suty/\alpha];\sigma)
\end{equation*}
  \end{enumerate}

%===============================================================================
\item[\fbox{\rref{L-RuleNoMatch}}]\quad$\dlres{\bar{\alpha},\alpha,\bar{\alpha}'}{\tenv,\alpha,\tenv'}{\tenv'',\envi{\rulet}{x}}{\type}{E'}$\ \\
%===============================================================================

The rule's first hypothesis states that
\begin{equation*}
  \not\exists \theta, E, \Sigma, \mathit{dom}(\theta) \subseteq (\bar{\alpha},\alpha,\bar{\alpha}'):
  \dmres{\theta(\tenv,\alpha,\tenv')}{\theta(\rulet)}{x}{\theta(\type)}{E}{\Sigma}
\end{equation*}
  Hence, the above also holds when we restrict $\theta$ to be of the form
$\theta' \cdot [\suty/\alpha]$. In this case, the above simplifies to
\begin{equation*}
  \not\exists \theta', E, \Sigma, \mathit{dom}(\theta) \subseteq (\bar{\alpha},\bar{\alpha}'):
  \dmres{\theta'(\tenv,\tenv'[\suty/\alpha])}{\theta'(\rulet[\suty/\alpha])}{x}{\theta'(\type[\suty/\alpha])}{E}{\Sigma}
\end{equation*}
  From the rule's second hypothesis and the induction hypothesis we have
\begin{equation*}
  \dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\tenv'''}{\type[\suty/\alpha]}{E'[|\suty|/\alpha]}
\end{equation*}
  With rule \rref{L-RuleNoMatch} we combine these two observations into the desired first result
\begin{equation*}
  \dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,(\tenv',\envi{\rulet}{x})[\suty/\alpha]}{\tenv'''}{\type[\suty/\alpha]}{E'[|\suty|/\alpha]}
\end{equation*}

  Similarly, following the rule's second hypothesis and the induction hypothesis we have:
\begin{equation*}
  R(\tenv;\alpha;\tenv';\tenv'';\tenv''';\suty)
\end{equation*}

  We do a case analysis on the derivation of this judgement.
  \begin{enumerate}
  \item \mylabel{R-1}: \\ Then we have
\begin{equation*}
  \tenv = \tenv_1,x:\rulet,\tenv_2  \andl \tenv'' = \tenv_1 \andl \tenv''' = \tenv_1
\end{equation*}
       By rule \mylabel{R-2} we then have
\begin{equation*}
R((\tenv_1,x:\rulet),\tenv_2;\alpha;\tenv';\tenv_1,\envi{\rulet}{x};\tenv_1,\envi{\rulet}{x};\suty)
\end{equation*}
        which, given all the equations we have, is equivalent to
\begin{equation*}
R(\tenv;\alpha;\tenv';\tenv'',\envi{\rulet}{x};\tenv'',\envi{\rulet}{x};\suty)
\end{equation*}

  \item \mylabel{R-2}: \\
   Then we have
\begin{equation*}
  \tenv' = \tenv_1',\tenv_2'  \andl \tenv'' = \tenv,\alpha,\tenv_1' \andl 
      \tenv''' = \tenv,\tenv_1'[\suty/\alpha]
\end{equation*}
  Since $\tenv'',\envi{\rulet}{x} \subseteq \tenv,\alpha,\tenv'$, it follows that $\tenv_2' = \envi{\rulet}{x},\tenv_{2,2}'$.
  Hence, by rule $\mylabel{R-2}$ we can establish
\begin{equation*}
R(\tenv;\alpha;(\tenv_1',\envi{\rulet}{x}),\tenv_2';\tenv,\alpha,(\tenv_1',\envi{\rulet}{x});\tenv,(\tenv_1',\envi{\rulet}{x})[\suty/\alpha];\suty)
\end{equation*}
        which, given all the equations we have, is equivalent to
\begin{equation*}
R(\tenv;\alpha;\tenv';\tenv'',\envi{\rulet}{x};\tenv,(\tenv_1',\envi{\rulet}{x})[\suty/\alpha];\suty)
\end{equation*}
  \end{enumerate}
  
%===============================================================================
\item[\fbox{\rref{L-Var}}]\quad$\dlres{\bar{\alpha},\alpha,\bar{\alpha}'}{\tenv,\alpha,\tenv'}{\tenv'', \relation{x}{\rulet}}{\type}{E}$\ \\
%===============================================================================

Then following the rule's hypothesis and the induction hypothesis we have:
\begin{equation*}
  \dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\tenv'''}{\type[\suty/\alpha]}{E[|\suty|/\alpha]}
%  \bar{\alpha},\bar{\alpha}';\tenv,\tenv'[\suty/\alpha];\tenv''' \ivturns \type[\suty/\alpha] \leadsto E[|\suty|/\alpha]
\end{equation*}
  By rule \rref{L-Var} and the definition of substitution we then have
\begin{equation*}
  \dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\tenv''',\relation{x}{\rulet[\suty/\alpha]}}{\type[\suty/\alpha]}{E[|\suty|/\alpha]}
%  \bar{\alpha},\bar{\alpha}';\tenv,\tenv'[\suty/\alpha];\tenv''',x:\rulet[\suty/\alpha] \ivturns \type[\suty/\alpha] \leadsto E[|\suty|/\alpha]
\end{equation*}
  Similarly, following the rule's hypothesis and the induction hypothesis we have:
\begin{equation*}
  R(\tenv;\alpha;\tenv';\tenv'';\tenv''';\suty)
\end{equation*}

  We do a case analysis on the derivation of this judgement.
  \begin{enumerate}
  \item \mylabel{R-1}: \\ Then we have
\begin{equation*}
  \tenv = \tenv_1,\relation{x}{\rulet},\tenv_2  \andl \tenv'' = \tenv_1 \andl \tenv''' = \tenv_1
\end{equation*}
       By rule \mylabel{R-2} we then have
\begin{equation*}
R((\tenv_1,\relation{x}{\rulet}),\tenv_2;\alpha;\tenv';\tenv_1,\relation{x}{\rulet};\tenv_1,\relation{x}{\rulet};\suty)
\end{equation*}
        which, given all the equations we have, is equivalent to
\begin{equation*}
R(\tenv;\alpha;\tenv';\tenv'',\relation{x}{\rulet};\tenv'',\relation{x}{\rulet};\suty)
\end{equation*}

  \item \mylabel{R-2}: \\
   Then we have
\begin{equation*}
  \tenv' = \tenv_1',\tenv_2' \andl \tenv'' = \tenv,\alpha,\tenv_1' \andl
      \tenv''' = \tenv,\tenv_1'[\suty/\alpha]
\end{equation*}

  Since $\tenv'',\relation{x}{\rulet} \subseteq \tenv,\alpha,\tenv'$, it follows that $\tenv_2' = \relation{x}{\rulet},\tenv_{2,2}'$.
  Hence, by rule $\mylabel{R-2}$ we can establish
\begin{equation*}
R(\tenv;\alpha;(\tenv_1',\relation{x}{\rulet}),\tenv_2';\tenv,\alpha,(\tenv_1',\relation{x}{\rulet});\tenv,(\tenv_1',\relation{x}{\rulet})[\suty/\alpha];\suty)
\end{equation*}
        which, given all the equations we have, is equivalent to
\begin{equation*}
R(\tenv;\alpha;\tenv';\tenv'',\relation{x}{\rulet};\tenv,(\tenv_1',\relation{x}{\rulet})[\suty/\alpha];\suty)
\end{equation*}
  \end{enumerate}

%===============================================================================
\item[\fbox{\rref{L-TyVar}}]\quad$\dlres{\bar{\alpha},\alpha,\bar{\alpha}'}{\tenv,\alpha,\tenv'}{\tenv'',\beta}{\type}{E}$\\
%$\bar{\alpha},\alpha,\bar{\alpha}';\tenv,\alpha,\tenv';\tenv'',\beta \ivturns \type \leadsto E$ \ \\
%===============================================================================

  Then following the rule's hypothesis and the induction hypothesis we have:
\begin{equation*}
  \dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\tenv'''}{\type[\suty/\alpha]}{E[|\suty|/\alpha]}
%  \bar{\alpha},\bar{\alpha}';\tenv,\tenv'[\suty/\alpha];\tenv''' \ivturns \type[\suty/\alpha] \leadsto E[|\suty|/\alpha]
\end{equation*}
  By rule \rref{L-TyVar} and the definition of substitution we then have
\begin{equation*}
  \dlres{\bar{\alpha},\bar{\alpha}'}{\tenv,\tenv'[\suty/\alpha]}{\tenv''',\beta}{\type[\suty/\alpha]}{E[|\suty|/\alpha]}
%  \bar{\alpha},\bar{\alpha}';\tenv,\tenv'[\suty/\alpha];\tenv''',\beta \ivturns \type[\suty/\alpha] \leadsto E[|\suty|/\alpha]
\end{equation*}
  Similarly, following the rule's hypothesis and the induction hypothesis we have:
\begin{equation*}
  R(\tenv;\alpha;\tenv';\tenv'';\tenv''';\suty)
\end{equation*}

  We do a case analysis on the derivation of this judgement.
  \begin{enumerate}
  \item \mylabel{R-1}: \\ Then we have
\begin{equation*}
  \tenv = \tenv_1,\tenv_2 \andl \tenv'' = \tenv_1 \andl \tenv''' = \tenv_1
\end{equation*}
  We further distinguish between two mutually exclusive cases:
  \begin{enumerate}
  \item $\tenv_2 = \epsilon$ \\
        It follows that $\alpha = \beta$ and we can establish by means of \mylabel{R-2} that
\begin{equation*}
R(\tenv_1,\tenv_2;\alpha;\epsilon,\tenv';\tenv_1,\tenv_2,\alpha;\tenv_1,\tenv_2,\epsilon[\suty/\alpha];\suty)
\end{equation*}
        which, given all the equations we have, is equivalent to
\begin{equation*}
R(\tenv;\alpha;\tenv';\tenv'',\beta;\tenv;\suty)
\end{equation*}

  \item $\tenv_2 \neq \epsilon$ \\
       Then it follows that $\tenv_2 = \beta,\tenv_{2,2}$ and by rule \mylabel{R-2} we have
\begin{equation*}
R((\tenv_1,\beta),\tenv_{2,2};\alpha;\tenv';\tenv_1,\beta;\tenv_1,\beta;\suty)
\end{equation*}
        which, given all the equations we have, is equivalent to
\begin{equation*}
R(\tenv;\alpha;\tenv';\tenv'',\beta;\tenv_1,\beta;\suty)
\end{equation*}
  \end{enumerate}

  \item \mylabel{R-2}: \\
   Then we have
\begin{equation*}
  \tenv' = \tenv_1',\tenv_2' \andl \tenv'' = \tenv,\alpha,\tenv_1' \andl
      \tenv''' = \tenv,\tenv_1'[\suty/\alpha]
\end{equation*}

  Since $\tenv'',\beta \subseteq \tenv,\alpha,\tenv'$, it follows that $\tenv_2' = \beta,\tenv_{2,2}'$.
  Hence, by rule $\mylabel{R-2}$ we can establish
\begin{equation*}
R(\tenv;\alpha;(\tenv_1',\beta),\tenv_2';\tenv,\alpha,(\tenv_1',\beta);\tenv,(\tenv_1',\beta)[\suty/\alpha];\suty)
\end{equation*}
        which, given all the equations we have, is equivalent to
\begin{equation*}
R(\tenv;\alpha;\tenv';\tenv'',\beta;\tenv,(\tenv_1',\beta)[\suty/\alpha];\suty)
\end{equation*}
  \end{enumerate}
\end{description}
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:coherence:3}
  If 
\begin{equation*}
  \dmres{\tenv,\alpha,\tenv'}{\rulet}{E}{\type}{E'}{\ie{\ruleset}{\bar{x}}}
\end{equation*}
  then
\begin{equation*}
  \dmres{\tenv,\tenv'[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[|\suty|/\alpha]}{\type[\suty/\alpha]}{E'[|\suty|/\alpha]}{\ie{\ruleset[\suty/\alpha]}{\bar{x}}}
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the hypothesis.
\begin{description}
\setlength{\itemsep}{1em}
%===============================================================================
\item[\fbox{\rref{M-Simp}}]\quad$\dmres{\tenv,\alpha,\tenv'}{\type}{E}{\type}{E}{\epsilon}$\\
%===============================================================================

The desired conclusion follows directly from rule \rref{M-Simp}
\begin{equation*}
\dmres{\tenv,\tenv'[\suty/\alpha]}{\type[\suty/\alpha]}{E[|\suty/\alpha|]}{\type[\suty/\alpha]}{E[|\suty/\alpha|]}{\epsilon}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{M-IApp}}]\quad$\dmres{\tenv,\alpha,\tenv'}{\rulet_1 \To \rulet_2}{E}{\type}{E'}{\Sigma,\ie{\rulet_1}{x}}$\\
%===============================================================================

From the rule's hypothesis and the induction hypothesis we have 
\begin{equation*}
\dmres{\tenv,(\tenv',\envi{\rulet_1}{x})[\suty/\alpha]}{\rulet_2[\suty/\alpha]}{(E~x)[|\suty|/\alpha]}{\type[\suty/\alpha]}{E'[|\suty|/\alpha]}{(\rulet_1~\gbox{\leadsto x},\Sigma)[\suty/\alpha]}
\end{equation*}
  Then from the definition of substutition and rule \rref{M-IApp} we conclude
\begin{equation*}
  \dmres{\tenv,\tenv'[\suty/\alpha]}{(\rulet_1 \To \rulet_2)[\suty/\alpha]}{E[|\suty|/\alpha]}{\type[\suty/\alpha]}{E'[|\suty|/\alpha]}{\Sigma[\suty/\alpha]}
%  \tenv,\tenv'[\suty/\alpha]; (\rulet_1 \iarrow \rulet_2)[\suty/\alpha] \leadsto E[|\suty|/\alpha] \ivturns \type[\suty/\alpha] \leadsto E'[|\suty|/\alpha]; (\Sigma,\rulet_1 \leadsto x)[\suty/\alpha]
\end{equation*}

%===============================================================================
\item[\fbox{\rref{M-TApp}}]\quad$\dmres{\tenv,\alpha,\tenv'}{\tall{\beta}{\rulet}}{E}{\type}{E'}{\Sigma}$\\
%$\tenv,\alpha,\tenv'; \forall\beta.\rulet \leadsto E \ivturns \type \leadsto E'; \Sigma$ \ \\
%===============================================================================

  From the rule's hypothesis and the induction hypothesis we have 
\begin{equation*}
  \dmres{\tenv,\tenv'[\suty/\alpha]}{\rulet[\suty'/\beta][\suty/\alpha]}{(E |\suty'|)[|\suty|/\alpha]}{\type[\suty/\alpha]}{E'[|\suty|/\alpha]}{\Sigma[\suty/\alpha]}
%  \tenv,\tenv'[\suty/\alpha]; \rulet[\suty'/\beta][\suty/\alpha] \leadsto (E |\suty'|)[|\suty|/\alpha] \ivturns \type[\suty/\alpha] \leadsto E'[|\suty|/\alpha]; \Sigma[\suty/\alpha]
\end{equation*}

  We conclude by rule \rref{M-TApp}, reasoning modulo
  the definition of substitution
\begin{equation*}
  \dmres{\tenv,\tenv'[\suty/\alpha]}{(\tall{\beta}{\rulet})[\suty/\alpha]}{E[|\suty|/\alpha]}{\type[\suty/\alpha]}{E'[|\suty|/\alpha]}{\Sigma[\suty/\alpha]}
%  \tenv,\tenv'[\suty/\alpha]; (\forall\beta.\rulet)[\suty/\alpha] \leadsto E[|\suty|/\alpha] \ivturns \type[\suty/\alpha] \leadsto E'[|\suty|/\alpha]; \Sigma[\suty/\alpha]
\end{equation*}
\end{description}
\end{proof}

%###############################################################################

\fbox{ \centering
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:asoundness:0}
  If 
\begin{equation*}
  \wte{\tenv}{\mmapp{(\Abs{\alpha}{e})}{\suty}}{\rulet[\suty/\alpha]}{\mmapp{(\Abs{\alpha}{E})}{\etrans{\suty}}}
\end{equation*}
  then
\begin{equation*}
  \wte{\tenv}{e[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[\ttrans[\suty]/\alpha]}
\end{equation*}
\end{lemma}
\end{minipage}
}

\begin{proof}
By case analysis, the two last rules used in the derivation of the theorem's hypothesis must be
instances of \rref{Ty-TAbs} and \rref{Ty-TApp}, as shown below.

\begin{equation*}
\inferrule*[Left=\textsc{Ty-TApp}]
  {
    {\inferrule*[Left=\textsc{Ty-TAbs}]
      {\wte{\tenv,\alpha}{e}{\rulet}{E}}
      {\wte{\tenv}{\Abs{\alpha}{e}}{\forall\alpha.\rulet}{\Abs{\alpha}{E}}}}
%       \and \wfty{\tenv}{\suty}
  }
  {
    \wte{\tenv}{\mmapp{(\Abs{\alpha}{e})}{\suty}}{\rulet[\suty/\alpha]}{\mmapp{(\Abs{\alpha}{E})}{\etrans{\suty}}}
  }
\end{equation*}
Therefore, it suffices to show that
\begin{equation*}
\begin{array}{r l}
\text{If}&\wte{\tenv,\alpha}{e}{\rulet}{E}\\
%\text{and}&\wfty{\tenv}{\suty},\\
\text{then}&\wte{\tenv}{e[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[\etrans{\suty}/\alpha]}
\end{array}
\end{equation*}
This can be proven as a special case ($\tenv' = \epsilon$) of the following theorem.
\end{proof}

%###############################################################################
\fbox{ \centering
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:asoundness:1}
  If 
\begin{equation*}
  \wte{\tenv,\alpha,\tenv'}{e}{\rulet}{E}
\end{equation*}
%  and
%\begin{equation*}
%  \wfty{\tenv}{\suty}
%\end{equation*}
  then
\begin{equation*}
  \wte{\tenv,\tenv'[\suty/\alpha]}{e[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[\ttrans[\suty]/\alpha]}
\end{equation*}
\end{lemma}
\end{minipage}
}

\begin{proof}
The proof proceeds by induction on the first hypothesis.\\

%===============================================================================
\item[\fbox{\rref{Ty-Var}}]\quad$\wte{\tenv,\alpha,\tenv'}{x}{\rulet}{x}$\\
%===============================================================================
From the rule's premise, we know that $(\relation{x}{\rulet}) \in \tenv,\alpha, \tenv'$.
Hence, it also holds that
$(\relation{x}{\rulet[\suty/\alpha]}) \in \tenv,\tenv'[\suty/\alpha]$. Rule \rref{Ty-Var} can then be instantiated with the latter, to conclude
$\wte{\tenv,\tenv'[\suty/\alpha]}{x}{\rulet[\suty/\alpha]}{x}$.\\

%===============================================================================
\item[\fbox{\rref{Ty-Abs}}]\quad$\wte{\tenv,\alpha,\tenv'}{\abs{x}{\rulet_1}{e}}{\rulet_1\to\rulet_2}{\abs{x}{\etrans{\rulet_1}}{E}}$\\
%===============================================================================
From the rule's premise, we get
$\wte{\tenv,\alpha,\tenv',\relation{x}{\rulet_1}}{e}{\rulet_2}{E}$. By passing this to the
induction hypothesis, we obtain
\begin{equation*}
\wte{\tenv,\tenv'[\suty/\alpha],\relation{x}{\rulet_1[\suty/\alpha]}}{e}{\rulet_2[\suty/\alpha]}{E[\etrans{\suty}/\alpha]}
\end{equation*}
From the definition of substitution and by supplying the latter to rule \rref{Ty-Abs}, we reach
the goal.\\

%===============================================================================
\item[\fbox{\rref{Ty-App}}]\quad$\wte{\tenv,\alpha,\tenv'}{\mmapp{e_1}{e_2}}{\rulet_2}{\mmapp{E_1}{E_2}}$\\
%===============================================================================
From the assumptions of rule \rref{Ty-App}, the induction hypothesis and the definition of
substitution, we obtain
\begin{equation*}
\wte{\tenv,\tenv'[\suty/\alpha]}{e_2}{\rulet_1[\suty/\alpha]\to\rulet_2[\suty/\alpha]}{E_1[\etrans{\suty}/\alpha]}
\end{equation*}
and
\begin{equation*}
\wte{\tenv,\tenv'[\suty/\alpha]}{e_1}{\rulet_1[\suty/\alpha]}{E_2[\etrans{\suty}/\alpha]}
\end{equation*}
By instantiating rule \rref{Ty-App} with the two judgments above, we obtain our goal.\\

%===============================================================================
\item[\fbox{\rref{Ty-TAbs}}]\quad$\wte{\tenv,\alpha,\tenv'}{\Abs{\alpha'}{e}}{\tall{\alpha'}{\rulet}}{\Abs{\alpha'}{E}}$\\
%===============================================================================
From the assumptions of rule \rref{Ty-TAbs} and the induction hypothesis, we obtain
\begin{equation*}
\wte{\tenv,(\tenv',\alpha')[\suty/\alpha]}{e[\suty/\alpha]}{\rulet}{E\etrans{\suty}/\alpha]}
\end{equation*}
where, from the definition of substitution, we have
$(\tenv',\alpha')[\suty/\alpha] = \tenv'[\suty/\alpha],\alpha'$. Using this equation in the judgment above, we reach the goal by applying rule \rref{Ty-TAbs} on it.\\

%===============================================================================
\item[\fbox{\rref{Ty-TApp}}]\quad
$\wte{\tenv,\alpha,\tenv'}{\mmapp{e}{\rulet_1}}{\rulet_2[\rulet_1/\alpha']}{\mmapp{E}{\etrans{\rulet_1}}}$\\
%===============================================================================
%Note that $\alpha \neq \alpha'$.
The first assumption of rule \rref{Ty-TApp} is
\begin{equation*}
\wte{\tenv,\alpha,\tenv'}{e}{\tall{\alpha'}{\rulet_2}}{E}
\end{equation*}
Then, from the induction hypothesis and the definition of substitution, we get
\begin{equation*}
\wte{\tenv,\tenv'[\suty/\alpha]}{e[\suty/\alpha]}{\tall{\alpha'}{(\rulet_2[\suty/\alpha])}}{E[\etrans{\suty}/\alpha]}
\end{equation*}
%From the second hypothesis of rule \rref{Ty-TApp} and by presevation of type well-scoping
%under type substitution (straight-forward to prove) we get
%\begin{equation*}
%\wfty{\tenv,\tenv'[\suty/\alpha]}{\rulet_1[\suty/\alpha]}
%\end{equation*}

Using this in rule \rref{Ty-TApp}, we get
\begin{equation*}
\wte{\tenv,\tenv'[\suty/\alpha]}{\mmapp{(e[\suty/\alpha])}{(\rulet_1[\suty/\alpha])}}{(\rulet_2[\suty/\alpha])[\rulet_1[\suty/\alpha] /\alpha']}{\mmapp{E[\etrans{\suty}/\alpha]}{\etrans{\rulet_1[\suty/\alpha]}}}
\end{equation*}
which is syntactically equal to our goal, since by the definition of substitution and type
translation and from the commutativity-like property of substitution composition, we get the following equations.
\begin{equation*}
\arraycolsep=1.4pt\def\arraystretch{1.5}
\begin{array}{c}
\mmapp{(e[\suty/\alpha])}{(\rulet_1[\suty/\alpha])} = (\mmapp{e}{\rulet_1})[\suty/\alpha]\\
(\rulet_2[\suty/\alpha])[\rulet_1[\suty/\alpha] /\alpha'] = \rulet_2[\rulet_1/\alpha'][\suty/\alpha]\\
\mmapp{E[\etrans{\suty}/\alpha]}{\etrans{\rulet_1[\suty/\alpha]}} = \mmapp{E[\etrans{\suty}/\alpha]}{\etrans{\rulet_1}[\etrans{\suty}/\alpha]} = (\mmapp{E}{\rulet_1})[\etrans{\suty}/\alpha]
\end{array}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{Ty-IAbs}}]\quad$\wte{\tenv,\alpha,\tenv'}{\ruleabs{\rulet_1}{e}}{\rulet_1 \iarrow \rulet_2}{\abs{x}{\etrans{\rulet_1}}{E}}$\\
%===============================================================================
From the first assumption of rule \rref{Ty-IAbs} and the induction hypothesis, we get
\begin{equation*}
\wte{\tenv,\tenv'[\suty/\alpha],\envi{\rulet_1[\suty/\alpha]}{x}}{e[\suty/\alpha]}{\rulet_2[\suty/\alpha]}{E[\etrans{\suty}/\alpha]}
\end{equation*}
Passing the second assumption of rule \rref{Ty-IAbs} to Lemma~\ref{lemma:unamb_subst:0}, we get
\begin{equation*}
\unambig{}{\rulet_1[\suty/\alpha]}
\end{equation*}
%By preservation of type well-scoping under type substitution, it also holds that
%\begin{equation*}
%\wfty{\tenv,\tenv'[\suty/\alpha]}{\rulet_1[\suty/\alpha]}
%\end{equation*}
By using the two obtained results and the freshness assumption of rule \rref{Ty-IAbs}
to instantiate a new \rref{Ty-IAbs} rule, we reach the goal.\\

%===============================================================================
\item[\fbox{\rref{Ty-IApp}}]\quad$\wte{\tenv,\alpha,\tenv'}{\ruleapp{e_1}{e_2}}{\rulet_1}{\mmapp{E_1}{E_2}}$\\
%===============================================================================
From the two assumptions of rule \rref{Ty-IApp}, the induction hypothesis and the definition of
substitution, we obtain
\begin{equation*}
\begin{array}{c}
\wte{\tenv,\tenv'[\suty/\alpha]}{e_1[\suty/\alpha]}{\rulet_2[\suty/\alpha]\To\rulet_1[\suty/\alpha]}{E_1[\etrans{\suty}/\alpha]}\\
\text{and}\quad\wte{\tenv,\tenv'[\suty/\alpha]}{e_2[\suty/\alpha]}{\rulet_2[\suty/\alpha]}{E_2[\etrans{\suty}/\alpha]}
\end{array}
\end{equation*}
By passing the two judgments above to rule \rref{Ty-IAbs}, we obtain the desired result.\\

%===============================================================================
\item[\fbox{\rref{Ty-Query}}]\quad$\wte{\tenv,\alpha,\tenv'}{?\rulet}{\rulet}{E}$\\
%===============================================================================
From the first assumption of rule \rref{Ty-Query}, where we consider deterministic
resolution, and Lemma~\ref{lemma:coherence:0} we get
\begin{equation*}
\dres{\tenv,\tenv'[\suty/\alpha]}{\rulet[\suty/\alpha]}{E[\etrans{\suty}/\alpha]}
\end{equation*}
%From the second assumption of rule \rref{Ty-Query}, the second hypothesis of this theorem and
%the property of type well-scoping under substitution, we have
%\begin{equation*}
%\wfty{\tenv,\tenv'[\suty/\alpha]}{\rulet[\suty/\alpha]}
%\end{equation*}
Passing the second assumption of rule \rref{Ty-Query} to Lemma~\ref{lemma:unamb_subst:0}
results in
\begin{equation*}
\unambig{}{\rulet[\suty/\alpha]}
\end{equation*}
Then, we can instantiate rule \rref{Ty-Query} with the two obtained results above,
to reach the goal of this case.
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:unamb_subst:0}
  If
\begin{equation*}
  \unambig{}{\rulet}
\end{equation*}
  then
\begin{equation*}
  \unambig{}{\rulet[\suty/\alpha]}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
The proof proceeds by induction on the theorem's third hypothesis, mutually with the next proof.
The only induction case of this proof, \rref{UA-Main}, is proved as a special case
($\bar{\alpha} = \epsilon$) of Lemma~\ref{lemma:unamb_subst:1}, since naturally
$\alpha\notin\epsilon$.
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:unamb_subst:1}
  If 
\begin{equation*}
  \unambig{\bar{\alpha}}{\rulet}
\end{equation*}
  and
\begin{equation*}
  \alpha\notin\bar{\alpha}
\end{equation*}
  then
\begin{equation*}
  \unambig{\bar{\alpha}}{\rulet[\suty/\alpha]}
\end{equation*}
\end{lemma}
\end{minipage}
}}
\begin{proof}
\klara{Update to not use well-scoping.}
The proof proceeds by induction on the theorem's first hypothesis, mutually with the previous
proof.\\

%===============================================================================
\item[\fbox{\rref{UA-Simp}}]\quad$\unambig{\bar{\alpha}}{\tau}$\\
%===============================================================================
We need to show that $\unambig{\bar\alpha}{\tau[\suty/\alpha]}$, which can be satisfied only
by (an appropriate instance of) rule \rref{UA-Simp}. Therefore, it suffices to show that
$\bar\alpha\subseteq\ftv{\tau[\suty/\alpha]}$.

From the first two hypotheses of the theorem, we know that $\alpha\notin\ftv{\suty}$. Using this,
we can conclude
\begin{equation*}
\arraycolsep=1.4pt\def\arraystretch{1}
\begin{array}{rl}
\ftv{\tau[\suty/\alpha]}&=(\ftv{\tau}\setminus\{\alpha\})\cup\ftv{\suty}\\
                        &=(\ftv{\tau}\cup\ftv{\suty})\setminus\{\alpha\}
\end{array}
\end{equation*}

From the assumption of rule \rref{UA-Main}, we have that $\bar\alpha\subseteq\ftv{\tau}$.
Then, it holds also that $\bar\alpha\subseteq\ftv{\tau}\cup\ftv{\suty}$ and from the fourth
hypothesis of the theorem, we reach the goal:
\begin{equation*}
\bar\alpha\subseteq(\ftv{\tau}\cup\ftv{\suty})\setminus\{\alpha\}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{UA-TAbs}}]\quad$\unambig{\bar{\alpha}}{\tall{\beta}{\rulet}}$\\
%===============================================================================
From the second hypothesis of the theorem and the adopted Barendregt convention, it follows that $\alpha\notin\bar\alpha,\beta$.

From the assumption of the rule and the induction hypothesis, we get
\begin{equation*}
\unambig{\bar{\alpha},\beta}{\rulet[\suty/\alpha]}
\end{equation*}
By using this in rule \rref{UA-TAbs} and from the definition of substitution, we reach the goal:
\begin{equation*}
\unambig{\bar{\alpha}}{(\tall{\beta}{\rulet})[\suty/\alpha]}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{UA-IAbs}}]\quad$\unambig{\bar{\alpha},\alpha,\bar{\alpha}'}{\rulet_1\To\rulet_2}$\\
%===============================================================================

Passing the first assumption of rule \rref{UA-IAbs} to Lemma~\ref{lemma:unamb_subst:0} results in
\begin{equation*}
\unambig{}{\rulet_1[\suty/\alpha]}
\end{equation*}
From the second assumption of rule \rref{UA-IAbs} and the induction hypothesis, we get
\begin{equation*}
\unambig{\bar{\alpha}}{\rulet_2[\suty/\alpha]}
\end{equation*}
By the definition of substitution and the last two obtained results used with rule
\rref{UA-IAbs}, we reach the goal:
\begin{equation*}
\unambig{\bar{\alpha}}{(\rulet_1\To\rulet_2)[\suty/\alpha]}
\end{equation*}
\end{proof}
%-------------------------------------------------------------------------------
\subsection{Soundness of the Algorithm wrt Deterministic Resolution}

%###############################################################################

\fbox{ \centering
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:asoundness:0}
  If 
\begin{equation*}
  \adres{\tenv}{\rulet}{E}
  %\tenv \alg \rulet \leadsto E
\end{equation*}
  then
\begin{equation*}
 \dres{\tenv}{\rulet}{E}
%  \tenv \ivturns \rulet \leadsto E
\end{equation*}
\end{lemma}
\end{minipage}
}

\begin{proof}
  From the hypothesis it follows that 
\begin{equation*}
  \adrres{\tyvars{\tenv}}{\tenv}{\rulet}{E}
%  \tyvars{\tenv};\tenv \alg \rulet \leadsto E
\end{equation*}
  Hence, by Lemma~\ref{lemma:asoundness:1} and rule \rref{R-Main} the desired conclusion follows
\begin{equation*}
  \dres{\tenv}{\rulet}{E}
%  \tenv \ivturns \rulet \leadsto E
\end{equation*}
\end{proof}

%###############################################################################

{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:asoundness:1}
  If 
\begin{equation*}
  \adrres{\bar\alpha}{\tenv}{\rulet}{E}
%  \bar{\alpha};\tenv \alg \rulet \leadsto E
\end{equation*}
  then
\begin{equation*}
  \drres{\bar\alpha}{\tenv}{\rulet}{E}
%  \bar{\alpha};\tenv \ivturns \rulet \leadsto E
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The lemma follows from the isomorphism between the 
rule sets of the two judgements and from Lemma~\ref{lemma:asoundness:2}.
\end{proof}

%###############################################################################

{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:asoundness:2}
  If 
\begin{equation*}
  \adlres{\bar\alpha}{\tenv}{\tenv'}{\rulet}{E}
%  \bar{\alpha};\tenv;\tenv' \alg \rulet \leadsto E
\end{equation*}
  then
\begin{equation*}
  \dlres{\bar\alpha}{\tenv}{\tenv'}{\rulet}{E}
%  \bar{\alpha};\tenv;\tenv' \ivturns \rulet \leadsto E
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the hypothesis.
\begin{description}
\setlength{\itemsep}{1em}
%===============================================================================
\item[\fbox{\rref{Alg-L-RuleMatch}}]\quad$\adlres{\bar\alpha}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E[\bar{E}/\bar{x}]}$\ \\
%$\bar{\alpha};\tenv; \tenv', \rulet~{\leadsto x} \alg \type~{\leadsto E[\bar{E}/\bar{x}]}$ \ \\
%===============================================================================
From the rule's first hypothesis and Lemma~\ref{lemma:asoundness:3} we have
\begin{equation*}
\dmres{\tenv}{\rulet}{E}{\type}{E'}{\ie{\ruleset}{\bar{x}}}
%\tenv; \rulet \leadsto E \ivturns \type \leadsto E'; \bar{\rulet} \leadsto \bar{x}
\end{equation*}
Then, using Lemma~\ref{lemma:asoundness:1} and rule \rref{L-RuleMatch} we conclude
\begin{equation*}
\dlres{\bar\alpha}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E[\bar{E}/\bar{x}]}
%\bar{\alpha};\tenv; \tenv', \rulet~{\leadsto x} \ivturns \type~{\leadsto E[\bar{E}/\bar{x}]}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{Alg-L-RuleNoMatch}}]\quad
$\adlres{\bar\alpha}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E'}$\ \\
%$\bar{\alpha};\tenv;\tenv', \rulet~{\leadsto x}\alg \type~{\leadsto E'}$ \ \\
%===============================================================================
  From the rule's second hypothesis and the induction hypothesis we have
\begin{equation*}
  \dlres{\bar\alpha}{\tenv}{\tenv'}{\type}{E'}
%  \bar{\alpha};\tenv;\tenv' \ivturns \type~{\leadsto E'}
\end{equation*}

  Then from the rule's first hypothesis and the negation of Lemma~\ref{lemma:asoundness:5}, we have:
\begin{equation*}
\not\exists E, \Sigma:
\admres{\bar\alpha}{\tenv}{\rulet}{x}{\epsilon}{\type}{E}{\Sigma}
%\bar{\alpha};\tenv;\rulet \leadsto x; \epsilon \alg \type \leadsto E; \Sigma
\end{equation*}
  By Lemma~\ref{lemma:asoundness:3} we thus have
\begin{equation*}
\not\exists \theta, E, \Sigma, \dom(\theta) \subseteq \bar{\alpha}:
\dmres{\theta(\tenv)}{\theta(\rulet)}{x}{\type}{E}{\Sigma}
%\theta(\tenv);\theta(\rulet) \leadsto x \ivturns \type \leadsto E; \Sigma
\end{equation*}
  Hence with rule \rref{L-RuleNoMatch} we conclude
\begin{equation*}
   \dlres{\bar\alpha}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E'}
%  \bar{\alpha};\tenv;\tenv',\rulet \leadsto x \ivturns \type~{\leadsto E'}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{Alg-L-Var}}]\quad
$\adlres{\bar\alpha}{\tenv}{\tenv',\relation{x}{\rulet}}{\type}{E}$\ \\
%$\bar{\alpha};\tenv;\tenv',x:\rulet \alg \type~{\leadsto E}$ \ \\
%===============================================================================
From the rule's hypothesis and the induction hypothesis we obtain
\begin{equation*}
  \dlres{\bar\alpha}{\tenv}{\tenv'}{\type}{E}
%  \bar{\alpha};\tenv;\tenv' \ivturns \type~{\leadsto E}
\end{equation*}
By rule \rref{L-Var} we conclude
\begin{equation*}
  \dlres{\bar\alpha}{\tenv}{\tenv',\relation{x}{\rulet}}{\type}{E}
%  \bar{\alpha};\tenv;\tenv',x:\rulet \ivturns \type~{\leadsto E}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{Alg-L-TyVar}}]\quad
$\adlres{\bar{\alpha}}{\tenv}{\tenv',\alpha}{\type}{E}$\ \\
%$\bar{\alpha};\tenv;\tenv',\alpha \alg \type~{\leadsto E}$ \ \\
%===============================================================================
From the rule's hypothesis and the induction hypothesis we obtain
\begin{equation*}
  \dlres{\bar{\alpha}}{\tenv}{\tenv'}{\type}{E}
%  \bar{\alpha};\tenv;\tenv' \ivturns \type~{\leadsto E}
\end{equation*}
By rule \rref{L-TyVar} we conclude
\begin{equation*}
  \dlres{\bar{\alpha}}{\tenv}{\tenv',\alpha}{\type}{E}
%  \bar{\alpha};\tenv;\tenv',\alpha \ivturns \type~{\leadsto E}
\end{equation*}
\end{description}
\end{proof}

We assume that the judgement is decorated with an additional argument, the substitution
for the $\bar{\alpha}$ type variables.

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:asoundness:3}
  If 
\begin{equation*}
\admress{\bar\alpha}{\tenv}{\rulet}{E}{\Sigma}{\type}{E'}{\Sigma',\theta(\Sigma)}{\theta}
%  \bar{\alpha};\tenv;\rulet \leadsto E; \Sigma \alg \type \leadsto E'; \Sigma',\theta(\Sigma); \theta
\end{equation*}
  and
\begin{equation*}
  \dom{(\theta)} \subseteq \bar{\alpha}
\end{equation*}
  then
\begin{equation*}
\dmres{\theta(\tenv)}{\theta(\rulet)}{\etrans\theta(E)}{\theta(\type)}{E'}{\Sigma'}
%  \theta(\tenv); \theta(\rulet) \leadsto |\theta|(E) \ivturns \theta(\type) \leadsto E'; \Sigma'
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the first hypothesis.
\begin{description}
\setlength{\itemsep}{1em}
%===============================================================================
\item[\fbox{\rref{Alg-M-Simp}}]\quad
$\admress{\bar\alpha}{\tenv}{\type'}{E}{\Sigma}{\type}{\etrans\theta(E)}{\epsilon,\theta(\Sigma)}{\theta}$\ \\
%$\bar{\alpha}; \tenv; \type' \leadsto E; \Sigma \alg \type \leadsto |\theta|(E); \epsilon,\theta(\Sigma);\theta$ \ \\
%===============================================================================
From the hypothesis of the rule and Lemma~\ref{lemma:asoundness:6} it follows that
$\theta(\type') = \theta(\type)$. Hence, the target judgement can be rewritten as
\begin{equation*}
  \dmres{\theta(\tenv)}{\theta(\type')}{\etrans\theta{E}}{\theta(\type')}{\etrans\theta{E}}{\epsilon}
%  \theta(\tenv); \theta(\type') \leadsto |\theta|(E) \ivturns \theta(\type') \leadsto |\theta|(E); \epsilon
\end{equation*}
This follows from rule \mylabel{M-Simp}.

%===============================================================================
\item[\fbox{\rref{Alg-M-IApp}}]\quad
$\admress{\bar\alpha}{\tenv}{\rulet_1\To\rulet_2}{E}{\Sigma}{\type}{E'}{\Sigma',\ie{\theta(\rulet_1)}{x}, \theta(\Sigma)}{\theta}$\ \\
%$\bar{\alpha}; \tenv; \rulet_1 \iarrow \rulet_2~{\leadsto E}; \Sigma \alg \type~{\leadsto E'}; \Sigma',\theta(\rulet_1) \leadsto x, \theta(\Sigma);\theta$ \ \\
%===============================================================================
  From the hypothesis of the rule and the induction hypothesis, we have that
\begin{equation*}
  \dmres{\tenv,\ie{\rulet_1}{x}}{\theta(\rulet_2)}{\etrans\theta(\mmapp{E}{x})}{\theta(\type)}{E'}{\Sigma'}
% \theta(\tenv,\rulet_1 \leadsto x); \theta(\rulet_2) \leadsto |\theta|(E\,x) \ivturns \theta(\type) \leadsto E'; \Sigma' 
\end{equation*}
  By rule \rref{M-IApp} we may then conclude
\begin{equation*}
\dmres{\theta(\tenv)}{\theta(\rulet_1\To\rulet_2)}{\etrans\theta(E)}{\theta(\type)}{E'}{\Sigma',\ie{\theta(\rulet_1)}{x}}
% \theta(\tenv); \theta(\rulet_1 \iarrow \rulet_2) \leadsto |\theta|(E) \ivturns \theta(\type) \leadsto E'; \Sigma',\theta(\rulet_1) \leadsto x
\end{equation*} 

%===============================================================================
\item[\fbox{\rref{Alg-M-TApp}}]\quad
$\admress{\bar\alpha}{\tenv}{\tall{\alpha}{\rulet}}{E}{\Sigma}{\type}{E'}{\Sigma',\theta(\Sigma)}{\theta}$\ \\
%$\bar{\alpha}; \tenv; \forall \alpha. \rulet~{\leadsto E}; \Sigma \alg \type~{\leadsto E'}; \Sigma',\theta(\Sigma);\theta$ \ \\
%===============================================================================
  Then it follows from the rule's hypothesis and from the induction hypothesis that
\begin{equation*}
\dmres{\theta(\tenv)}{\theta(\rulet)}{\etrans\theta(\mmapp{E}{\alpha})}{\theta(\type)}{E'}{\Sigma'}
%  \theta(\tenv); \theta(\rulet) \leadsto |\theta|(E\,\alpha) \ivturns \theta(\type) \leadsto E'; \Sigma'
\end{equation*}
  Hence, it follows from rule \rref{M-TApp} that
\begin{equation*}
  \dmres{\theta(\tenv)}{\theta(\tall{\alpha}{\rulet})}{\etrans\theta(E)}{\theta(\type)}{E'}{\Sigma'}
%  \theta(\tenv); \theta(\forall \alpha.\rulet) \leadsto |\theta|(E) \ivturns \theta(\type) \leadsto E'; \Sigma'
\end{equation*}
\end{description}
\end{proof}


%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:asoundness:5}
  If 
\begin{equation*}
  \admres{\bar\alpha}{\tenv}{\rulet}{E}{\Sigma}{\type}{E'}{\Sigma'}
%  \bar{\alpha};\tenv;\rulet \leadsto E; \Sigma \alg \type \leadsto E'; \Sigma'
\end{equation*}
  then
\begin{equation*}
  \coherent{\bar\alpha}{\tenv}{\rulet}{\type}
%  \bar{\alpha}; \tenv; \rulet \coh \type
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
  The derivation of the conclusion is obtained by erasing the irrelevant arguments
  from the derivation of the hypothesis.
\end{proof}


%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:asoundness:6}
  If 
\begin{equation*}
  \theta = \mgu{\type}{\type'}
\end{equation*}
  then
\begin{equation*}
  \theta(\type) = \theta(\type')
\end{equation*}
  and
\begin{equation*}
  \mathit{dom}(\theta) \subseteq \bar{\alpha}
\end{equation*}

\end{lemma}
\end{minipage}
}}

\begin{proof}
Straightforward induction on the derivation.
\end{proof}

%-------------------------------------------------------------------------------
\subsection{Completeness of the Algorithm wrt Deterministic Resolution}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:acompleteness:0}
  If 
\begin{equation*}
\dres{\tenv}{\rulet}{E}
%  \tenv \ivturns \rulet \leadsto E
\end{equation*}
  then
\begin{equation*}
  \adres{\tenv}{\rulet}{E}
%  \tenv \alg \rulet \leadsto E
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
  From the hypothesis it follows that 
\begin{equation*}
\drres{\tyvars{\tenv}}{\tenv}{\rulet}{E}
%  \mathit{tyvars}(\tenv);\tenv \ivturns \rulet \leadsto E
\end{equation*}
  Hence, by Lemma~\ref{lemma:acompleteness:1} and rule \mylabel{Alg-R-Main} the desired conclusion follows
\begin{equation*}
\adres{\tenv}{\rulet}{E}
%  \tenv \alg \rulet \leadsto E
\end{equation*}
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:acompleteness:1}
  If 
\begin{equation*}
  \drres{\bar\alpha}{\tenv}{\rulet}{E}
%  \bar{\alpha};\tenv \ivturns \rulet \leadsto E
\end{equation*}
  then
\begin{equation*}
  \adrres{\bar\alpha}{\tenv}{\rulet}{E}
%  \bar{\alpha};\tenv \alg \rulet \leadsto E
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The lemma follows from the isomorphism between the 
rule sets of the two judgements and from Lemma~\ref{lemma:acompleteness:2}.
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:acompleteness:2}
  If 
\begin{equation*}
  \dlres{\bar\alpha}{\tenv}{\tenv'}{\rulet}{E}
%  \bar{\alpha};\tenv;\tenv' \ivturns \rulet \leadsto E
\end{equation*}
  then
\begin{equation*}
  \adlres{\bar\alpha}{\tenv}{\tenv'}{\rulet}{E}
%  \bar{\alpha};\tenv;\tenv' \alg \rulet \leadsto E
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the hypothesis.
\begin{description}
\setlength{\itemsep}{1em}
%===============================================================================
\item[\fbox{\rref{L-RuleMatch}}]\quad
$\dlres{\bar\alpha}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E[\bar{E}/\bar{x}]}$\ \\
%$\bar{\alpha};\tenv; \tenv', \rulet~{\leadsto x} \ivturns \type~{\leadsto E[\bar{E}/\bar{x}]}$ \ \\
%===============================================================================
From the rule's first hypothesis and Lemma~\ref{lemma:acompleteness:3} we have
\begin{equation*}
  \admres{\epsilon}{\tenv}{\rulet}{x}{\epsilon}{\type}{E'}{\ie{\bar\rulet}{\bar{x}}}
%\epsilon; \tenv; \rulet \leadsto x; \epsilon \alg \type \leadsto E'; \bar{\rulet} \leadsto \bar{x}
\end{equation*}
Then, using Lemma~\ref{lemma:acompleteness:1} and rule \rref{Alg-L-RuleMatch} we conclude
\begin{equation*}
  \adlres{\bar\alpha}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E[\bar{E}/\bar{x}]}
%\bar{\alpha};\tenv; \tenv', \rulet~{\leadsto x} \alg \type~{\leadsto E[\bar{E}/\bar{x}]}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{L-RuleNoMatch}}]\quad
$\dlres{\bar\alpha}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E'}$\ \\
%$\bar{\alpha};\tenv;\tenv', \rulet~{\leadsto x}\ivturns \type~{\leadsto E'}$ \ \\
%===============================================================================
  From the rule's second hypothesis and the induction hypothesis we have
\begin{equation*}
  \adlres{\bar\alpha}{\tenv}{\tenv'}{\type}{E'}
%  \bar{\alpha};\tenv;\tenv' \alg \type~{\leadsto E'}
\end{equation*}

  From the rule's first hypothesis and the negation of Lemma~\ref{lemma:acompleteness:4}, we have:
\begin{equation*}
\incoherent{\bar\alpha}{\tenv}{\rulet}{\type}
%\bar{\alpha}; \rulet \not\coh \type
\end{equation*}
  Hence with rule \rref{Alg-L-RuleNoMatch} we conclude
\begin{equation*}
  \adlres{\bar\alpha}{\tenv}{\tenv',\envi{\rulet}{x}}{\type}{E'}
%  \bar{\alpha};\tenv;\tenv',\rulet \leadsto x \alg \type~{\leadsto E'}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{L-Var}}]\quad
$\dlres{\bar\alpha}{\tenv}{\tenv',\relation{x}{\rulet}}{\type}{E}$\ \\
%$\bar{\alpha};\tenv;\tenv',x:\rulet \ivturns \type~{\leadsto E}$ \ \\
%===============================================================================
From the rule's hypothesis and the induction hypothesis we obtain
\begin{equation*}
  \adlres{\bar\alpha}{\tenv}{\tenv'}{\type}{E}
%  \bar{\alpha};\tenv;\tenv' \alg \type~{\leadsto E}
\end{equation*}
By rule \rref{Alg-L-Var} we conclude
\begin{equation*}
  \adlres{\bar\alpha}{\tenv}{\tenv',\relation{x}{\rulet}}{\type}{E}
%  \bar{\alpha};\tenv;\tenv',x:\rulet \alg \type~{\leadsto E}
\end{equation*}

%===============================================================================
\item[\fbox{\rref{L-TyVar}}]\quad
$\dlres{\bar\alpha}{\tenv}{\tenv',\alpha}{\type}{E}$\ \\
%$\bar{\alpha};\tenv;\tenv',\alpha \ivturns \type~{\leadsto E}$ \ \\
%===============================================================================
From the rule's hypothesis and the induction hypothesis we obtain
\begin{equation*}
\adlres{\bar\alpha}{\tenv}{\tenv'}{\type}{E}
% \bar{\alpha};\tenv;\tenv' \alg \type~{\leadsto E}
\end{equation*}
By rule \rref{Alg-L-TyVar} we conclude
\begin{equation*}
  \adlres{\bar\alpha}{\tenv}{\tenv',\alpha}{\type}{E}
%  \bar{\alpha};\tenv;\tenv',\alpha \alg \type~{\leadsto E}
\end{equation*}
\end{description}
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:acompleteness:3}
  If 
\begin{equation*}
  \theta_1(\tenv); \theta_1(\rulet) \leadsto |\theta_1|(E) \ivturns \theta_1(\type) \leadsto |\theta_1|(E'); \theta_1(\Sigma')
\end{equation*}
  and
\begin{equation*}
  \mathit{dom}(\theta_1) \subseteq \bar{\alpha}
\end{equation*}
  then
\begin{equation*}
  \bar{\alpha};\tenv;\rulet \leadsto E; \Sigma \alg \type \leadsto |\theta_2|(E'); \theta_2(\Sigma',\Sigma)
\end{equation*}
  and
\begin{equation*}
  \mathit{dom}(\theta_2) \subseteq \bar{\alpha}
\end{equation*}
  and
\begin{equation*}
  \theta_1 \sqsubseteq \theta_2
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
The proof proceeds by induction on the derivation of the first hypothesis.
\begin{description}
\setlength{\itemsep}{1em}
%===============================================================================
\item[\fbox{\texttt{(M-Simp)}}]\quad$\theta_1(\tenv); \theta_1(\type') \leadsto |\theta_1|(E) \ivturns \theta_1(\type) \leadsto |\theta_1|(E); \theta_1(\epsilon)$ \hfill where $\theta_1(\tenv) = \theta_1(\type')$. \\
%===============================================================================

From Lemma~\ref{lemma:acompleteness:5} and rule \mylabel{Alg-M-Simp} we then have
\begin{equation*}
  \bar{\alpha}; \tenv; \type' \leadsto E; \Sigma \alg \type \leadsto \theta_2(E); \theta_2(\Sigma)
\end{equation*}

%===============================================================================
\item[\fbox{\texttt{(M-IApp)}}]\quad$\theta_1(\tenv); \theta_1(\rulet_1 \iarrow \rulet_2)~{\leadsto |\theta_1|(E)}\ivturns \theta_1(\type)~{\leadsto |\theta_1|(E')}; \theta_1(\Sigma',\rulet_1 \leadsto x)$ \ \\
%===============================================================================
  From the hypothesis of the rule and the induction hypothesis, we have that
\begin{equation*}
 \bar{\alpha};\tenv,\rulet_1 \leadsto x;\rulet_2 \leadsto E\,x; \rulet_1 \leadsto x, \Sigma \alg \type \leadsto |\theta_2|(E'); \theta_2(\Sigma',\rulet_1 \leadsto x, \Sigma) 
\end{equation*}
  By rule \mylabel{Alg-M-IApp} we may then conclude
\begin{equation*}
 \bar{\alpha};\tenv;\rulet_1 \iarrow \rulet_2 \leadsto E; \Sigma \alg \type \leadsto |\theta_2|(E'); \theta_2(\Sigma',\rulet_1 \leadsto x, \Sigma) 
\end{equation*} 

%===============================================================================
\item[\fbox{\texttt{(M-TApp)}}]\quad$\theta_1(\tenv); \theta_1(\forall\alpha.\rulet) \leadsto |\theta_1|(E) \ivturns \theta_1(\type) \leadsto |\theta_1|(E'); \theta_1(\Sigma')$ \ \\
%===============================================================================
  From the hypothesis of the rule and the induction hypothesis, we have that
\begin{equation*}
 \bar{\alpha},\alpha;\tenv;\rulet \leadsto E\,\alpha; \Sigma \alg \type \leadsto |\theta_2|(E'); \theta_2(\Sigma',\Sigma) 
\end{equation*}
  Hence, it follows from rule \mylabel{Alg-M-TApp} that
\begin{equation*}
 \bar{\alpha};\tenv;\forall \alpha.\rulet \leadsto E; \Sigma \alg \type \leadsto |\theta_2|(E'); \theta_2(\Sigma',\Sigma) 
\end{equation*}

\end{description}
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:acompleteness:4}
  If 
\begin{equation*}
  \bar{\alpha}; \rulet \coh \type
\end{equation*}
  then for all $E, \tenv, \Sigma$ there exist $E', \Sigma'$ such that
\begin{equation*}
  \bar{\alpha};\tenv;\rulet \leadsto E; \Sigma \alg \type \leadsto E'; \Sigma'
\end{equation*}
\end{lemma}
\end{minipage}
}}

\begin{proof}
  The proof is straightforward induction on the derivation. The conclusion's judgement
  is an annotated version of the hypothesis' judgement.
\end{proof}

%###############################################################################
{\centering
\fbox{
\begin{minipage}{0.95\columnwidth}
\begin{lemma}\label{lemma:acompleteness:5}
  If 
\begin{equation*}
  \theta(\type) = \theta(\type')
\end{equation*}
  and
\begin{equation*}
  \mathit{dom}(\theta) \subseteq \bar{\alpha}
\end{equation*}
  then
\begin{equation*}
  \theta' = \mgu{\type}{\type'}
\end{equation*}
  and
\begin{equation*}
  \mathit{dom}(\theta') \subseteq \bar{\alpha}
\end{equation*}
  and
\begin{equation*}
  \theta \sqsubseteq \theta'
\end{equation*}
\end{lemma}
\end{minipage}
}}

% \newcommand{\vdashr}[4]{#1; #2 \vturns #3 \leadsto #4}
% 
% \begin{proof}
% The proof proceeds by induction on the $\bar{\alpha};\env \vdash_r \rho \leadsto E$ derivation.
% \begin{description}
% \renewcommand{\itemsep}{10mm}
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% \item[\texttt{(R-IAbs)}] \quad
%     $\vdashr{\bar{\alpha}}{\env}{\rho_1 \iarrow \rho_2}{\lambda\relation{x}{||\rho_1||}.E}$ \ \\
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% From rule \mylabel{R-IAbs} and the induction hypothesis, it follows that
% \begin{equation*}
% \vdashr{\bar{\alpha}}{\theta(\env,\rho_1\leadsto x)}{\theta(\rho_2)}{\theta(E)}
% \end{equation*}
% Hence, using rule \mylabel{R-IAbs}, we conclude
% \begin{equation*}
% \vdashr{\bar{\alpha}}{\theta(\env)}{\theta(\rho_1\iarrow\rho_2)}{\theta(\lambda\relation{x}{||\rho_1||}.E)}
% \end{equation*}
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% \item[\texttt{(R-TAbs)}] \quad
%     $\vdashr{\bar{\alpha}}{\env}{\forall \alpha. \rho}{\Lambda\alpha.E}$ \ \\
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% From rule \mylabel{R-TAbs} and the induction hypothesis, it follows that
% \begin{equation*}
% \vdashr{\bar{\alpha},\alpha}{\theta(\env)}{\theta(\rho)}{\theta(E)}
% \end{equation*}
% Hence, using rule \mylabel{R-TAbs}, we conclude
% \begin{equation*}
% \vdashr{\bar{\alpha}}{\theta(\env)}{\theta(\forall \alpha. \rho)}{\theta(\Lambda\alpha.E)}
% \end{equation*}
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% \item[\texttt{(R-Simp)}] \quad
%     $\vdashr{\bar{\alpha}}{\env}{\tau}{E}$ \ \\
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% We distinguish two cases. Firstly, we assume
% that $\theta(\tau)$ yields the simple type $\tau'$.
% Then, it follows from rule \mylabel{R-Simp} and Lemma~\ref{} (TODO) that
% \begin{equation*}
% \elookup{\theta(\env)}{\theta(\tau)} = \theta(\rho)~\leadsto x
% \end{equation*}
% Similarly, it follows from rule \mylabel{R-Simp} and Lemma~\ref{} (TODO) that
% \begin{equation*}
% \bar{\alpha};\theta(\env); \theta(\rho)~\leadsto x
%    \turns_\downarrow \theta(\type)~\leadsto \theta(E)
% \end{equation*}
% Hence, using rule \mylabel{R-Simp} we conclude
% \begin{equation*}
% \vdashr{\bar{\alpha}}{\theta(\env)}{\theta(\tau)}{\theta(E)}
% \end{equation*}
% 
% Secondly, we assume that $\theta(\tau) = \forall \bar{\beta}.\tau'$.
% This happens only if $\tau = \alpha$.
% In this case, we can show:
% \begin{equation*}
% \vdashr{\bar{\alpha}}{\theta(\env)}{\theta(\tau)}{E'} \quad \wedge \quad E' \equiv_{\alpha,H} \theta(E)
% \end{equation*}
% if we take $E' = \Lambda\bar{\beta}.\theta(E)\,\bar{\beta}$
% by repeated application of rule \mylabel{R-TAbs} and showing that
% \begin{equation*}
% \vdashr{\bar{\alpha},\bar{\beta}}{\theta(\env)}{\tau'}{\theta(E)\,\bar{\beta}}
% \end{equation*}
% 
% %   \item $\theta(\tau) = \tau'$
% %   \item $\theta(\tau) = \forall \bar{\alpha'}.\tau'$
% \end{description}
% \end{proof}


% \begin{lemma}\label{lemma:substitution:lhd}
% The $\rho \lhd \tau$ judgement is stable under substitution.
% \[\forall \rho, \tau, \alpha, \suty: 
%     \rho \lhd \tau \quad \rightarrow \quad \theta(\rho) \lhd \head{\theta(\tau)}
% \]
% where $\theta = [\suty/\alpha]$.
% \end{lemma}
% \begin{proof}
% The proof proceeds by induction on the $\rho \lhd \tau$ derivation.
% \begin{description}
% \renewcommand{\itemsep}{10mm}
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% \item[\texttt{(M-IApp)}] \quad
%     $\rho_1 \iarrow \rho_2 \lhd \tau$ \ \\
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% From rule \mylabel{M-IApp} and the induction hypothesis it follows that:
% \begin{equation*}
% \theta(\rho_2) \lhd \head{\theta(\tau)}
% \end{equation*}
% Then it follows from rule \mylabel{M-IApp} that:
% \begin{equation*}
% \theta(\rho_1) \iarrow \theta(\rho_2) \lhd \head{\theta(\tau)}
% \end{equation*}
% Hence, because $\theta(\rho_1) \iarrow \theta(\rho_2) = \theta(\rho_1 \iarrow \rho_2)$.
% we conclude:
% \begin{equation*}
% \theta(\rho_1 \iarrow \rho_2) \lhd \head{\theta(\tau)}
% \end{equation*}
% 
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% \item[\texttt{(M-TApp)}] \quad
%     $\forall \alpha. \rho \lhd \tau$ \ \\
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% From rule \mylabel{M-TApp} and the induction hypothesis it follows that:
% \begin{equation*}
% \theta(\rho[\suty'/\alpha']) \lhd \head{\theta(\tau)}
% \end{equation*}
% We can commute the two substitutions as follows because their
% domains are disjoint:
% \begin{equation*}
% \theta(\rho)[\theta(\suty')/\alpha'] \lhd \head{\theta(\tau)}
% \end{equation*}
% Then, by rule \mylabel{M-TApp}, we get:
% \begin{equation*}
% \forall \alpha. \theta(\rho) \lhd \head{\theta(\tau)}
% \end{equation*}
% Finally, because $\forall \alpha. \theta(\rho) = \theta(\forall \alpha. \rho)$,
% we conclude:
% \begin{equation*}
% \theta(\forall \alpha. \rho) \lhd \head{\theta(\tau)}
% \end{equation*}
% 
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% \item[\texttt{(M-Simp)}] \quad
%     $\tau \lhd \tau$ \ \\
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% We distinguish three cases:
% Firstly, we consider the case where $\tau = \rho_1 \arrow \rho_2$.
% Then, $\theta(\tau) = \head{\theta(\tau)}$ by rule \mylabel{M-Simp}
% we trivially have:
% \begin{equation*}
% \theta(\tau) \lhd \head{\theta(\tau)}
% \end{equation*}
% 
% Secondly, we consider the case where $\tau = \alpha' \neq \alpha$.
% Then, $\head(\theta(\tau)) = \head{\tau} = \tau$ and by rule 
% \mylabel{M-Simp} we trivally have:
% \begin{equation*}
% \theta(\tau) \lhd \head{\theta(\tau)}
% \end{equation*}
% 
% Thirdly, we consider the case where $\tau = \alpha$. Then $\theta(\tau) =
% \suty$.  We have that $\suty$ is of the general form $\forall
% \bar{\beta}.\tau'$. Hence, $\head{\theta(\tau)} = \tau'$.
% Then we can establish the desired goal:
% \begin{equation*}
% \forall \bar{\beta}.\tau' \lhd \tau'
% \end{equation*}
% by repeated application of rule \mylabel{M-TApp}
% choosing substitutions of the form $[\beta/\beta]$
% and the trivial base case $\tau' \lhd \tau'$ shown by rule
% \mylabel{M-Simp}.
% 
% \end{description}
% \end{proof}
% 
% \begin{lemma}\label{lemma:substitution:lookup}
% The $\elookup{\env}{\type} = \rho \leadsto x$ judgement is stable under substitution.
% \[\forall \env, \bar{\alpha}, \type, \rho, \alpha, \suty: 
%     \elookup{\env}{\type} = \rho \leadsto x
%     \quad\rightarrow\quad
%     \elookup{\theta(\env)}{\head{\theta(\type)}} = \theta(\rho) \leadsto x
% \]
% where $\theta = [\suty/\alpha]$.
% \end{lemma}
% \begin{proof}
% The proof proceeds by induction on the $\elookup{\env}{\type} = \rho \leadsto x$ derivation.
% \begin{description}
% \renewcommand{\itemsep}{10mm}
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% \item[\texttt{(L-Head)}] \quad
%     $\elookup{(\env,\rho \leadsto x)}{\type} = \rho \leadsto x$ \ \\
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% From rule \mylabel{L-Head} it follows that
% \begin{equation*}
% \rho \lhd \tau
% \end{equation*}
% Hence, from Lemma~\ref{lemma:substitution:lhd}, we know that:
% \begin{equation*}
% \theta(\rho) \lhd \head{\theta(\type)}
% \end{equation*}
% Thus we obtain with rule \mylabel{L-Head}:
% \begin{equation*}
% \elookup{(\theta(\env),\theta(\rho) \leadsto x)}{\head{\theta(\type)}} = \theta(\rho) \leadsto x
% \end{equation*}
% As $(\theta(\env),\theta(\rho) \leadsto x) = \theta(\env,\rho \leadsto x)$,
% this yields the desired result:
% \begin{equation*}
% \elookup{\theta(\env,\rho \leadsto x)}{\head{\theta(\type)}} = \theta(\rho) \leadsto x
% \end{equation*}
% 
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% \item[\texttt{(L-Tail)}] \quad
%     $\elookup{(\env,\rho_1 \leadsto x)}{\type} = \rho_2 \leadsto y$ \ \\
% %= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
% From rule \mylabel{L-Tail} and the induction hypothesis it follows that
% \begin{equation*}
% \elookup{\theta(\env)}{\head{\theta(\type)}} = \theta(\rho_2) \leadsto y
% \end{equation*}
% 
% Also from rule \mylabel{L-Tail} we have
% \begin{equation*}
% \forall \theta': 
% 	\theta'(\rulet_1) \mathop{\not\!\!\lhd} \head{\theta'(\type)}
% \end{equation*}
% As a consequence this also holds for every choice $\theta' = \theta'' \cdot \theta$.
% \begin{equation*}
% \forall \theta'': 
% 	\theta''(\theta(\rulet_1)) \mathop{\not\!\!\lhd} \head{\theta''(\theta(\type))}
% \end{equation*}
% Now we apply the property that $\mathrm{hd} \cdot \theta'' = \mathrm{hd} \cdot \theta'' \cdot \mathrm{hd}$:
% \begin{equation*}
% \forall \theta'': 
% 	\theta''(\theta(\rulet_1)) \mathop{\not\!\!\lhd} \head{\theta''(\head{\theta(\type)})}
% \end{equation*}
% We now have all the necessary ingredients to apply rule \mylabel{L-Tail}
% and to conclude:
% \begin{equation*}
% \elookup{(\theta(\env),\theta(\rho_1) \leadsto x)}{\head{\theta(\type)}} = \theta(\rho_2) \leadsto y
% \end{equation*}
% Finally, as $(\theta(\env),\theta(\rho_1) \leadsto x) = \theta(\env, \rho_1
% \leadsto x)$, we obtain the desired result:
% \begin{equation*}
% \elookup{\theta(\env,\rho_1 \leadsto x)}{\head{\theta(\type)}} = \theta(\rho_2) \leadsto y
% \end{equation*}
% 
% \end{description}
% \end{proof}
